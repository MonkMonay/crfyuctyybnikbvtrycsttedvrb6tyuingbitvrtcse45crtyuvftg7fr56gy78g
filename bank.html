<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank - Bonobudget</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700&display=swap">
    <style>
        body { background: #111; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
        .header { background: #222; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-radius: 0 0 20px 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #4caf50; }
        .nav { display: flex; gap: 30px; }
        .nav-item { color: #ccc; text-decoration: none; padding: 12px 20px; border-radius: 15px; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: #333; color: #fff; }
        .nav-item.active { background: #4caf50; color: #fff; }
        .profile { display: flex; align-items: center; gap: 15px; }
        .profile-email { color: #ccc; }
        .logout-btn { background: #ff5252; color: #fff; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; transition: background 0.2s; }
        .logout-btn:hover { background: #d32f2f; }
        .container { padding: 30px; max-width: 1200px; margin: 0 auto; }
        .question-container { background: #222; padding: 40px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center; }
        .question-title { color: #4caf50; font-size: 24px; margin-bottom: 20px; }
        .question-text { color: #ccc; font-size: 18px; margin-bottom: 30px; }
        .question-subtext { color: #999; font-size: 13px; margin-bottom: 16px; }
        .input-group { margin-bottom: 20px; }
        .amount-input { background: #333; border: 1px solid #444; color: #fff; padding: 15px; border-radius: 15px; width: 200px; font-size: 16px; text-align: center; }
        .skip-btn { background: #666; color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; transition: background 0.2s; }
        .skip-btn:hover { background: #777; }
        .back-btn { background: #37474f; }
        .back-btn:hover { background: #455a64; }
        .next-btn { background: #4caf50; color: #fff; border: none; padding: 15px 30px; border-radius: 15px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        .next-btn:hover { background: #388e3c; }
        .quick-btn { background: #444; color: #fff; border: 2px solid #666; padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        .quick-btn:hover { background: #555; border-color: #4caf50; transform: translateY(-2px); }
        .quick-btn.active { background: #4caf50; border-color: #4caf50; }
        .progress-bar { background: #333; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background: #4caf50; height: 100%; transition: width 0.3s; }
        .progress-text { color: #ccc; margin-bottom: 20px; }
        .summary-container { background: #222; padding: 30px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .summary-title { color: #4caf50; font-size: 24px; margin-bottom: 20px; }
        .category-section { margin-bottom: 25px; }
        .category-title { color: #4caf50; font-size: 18px; margin-bottom: 10px; font-weight: bold; }
        .expense-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; }
        .expense-item:last-child { border-bottom: none; }
        .expense-label { color: #ccc; }
        .expense-amount { color: #4caf50; font-weight: bold; }
        .skipped { color: #ff9800; font-style: italic; }
        .total-section { background: #333; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .total-text { font-size: 20px; color: #4caf50; font-weight: bold; }
        .edit-btn { background: #2196f3; color: #fff; border: none; padding: 12px 24px; border-radius: 15px; cursor: pointer; margin-top: 20px; transition: background 0.2s; }
        .edit-btn:hover { background: #1976d2; }
        .summary-column {
            padding: 20px;
            border-right: 1px solid #333; /* Add a separator between columns */
        }
        .summary-column:last-child {
            border-right: none; /* Remove separator for the last column */
        }
        .setup-view { background: #222; border-radius: 20px; padding: 35px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .setup-title { color: #4caf50; font-size: 28px; margin-bottom: 10px; text-align: center; }
        .setup-subtitle { color: #bbb; text-align: center; margin-bottom: 24px; }
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .setup-option {
            background: #2c2c2c;
            border: 1px solid #3a3a3a;
            border-radius: 14px;
            padding: 20px;
            cursor: pointer;
            text-align: left;
            color: #fff;
            transition: border-color 0.2s, transform 0.2s;
        }
        .setup-option:hover { border-color: #4caf50; transform: translateY(-1px); }
        .setup-option h3 { margin: 0 0 8px; font-size: 20px; color: #4caf50; }
        .setup-option p { margin: 0 0 10px; color: #bbb; font-size: 14px; line-height: 1.4; }
        .setup-chip {
            display: inline-block;
            font-size: 11px;
            color: #91ff96;
            border: 1px solid rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.15);
            border-radius: 999px;
            padding: 3px 8px;
        }
        .mode-badge {
            display: inline-block;
            font-size: 11px;
            color: #81c9ff;
            border: 1px solid rgba(33, 150, 243, 0.5);
            background: rgba(33, 150, 243, 0.15);
            border-radius: 999px;
            padding: 3px 8px;
            margin-bottom: 10px;
        }
        @media (max-width: 900px) {
            .setup-grid { grid-template-columns: 1fr; }
            .container { padding: 20px; }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">Bonobudget</div>
        <div class="nav">
            <div class="nav-item" onclick="window.location.href='dashboard.html'">Dashboard</div>
            <div class="nav-item active">Bank</div>
            <div class="nav-item" onclick="window.location.href='goals.html'">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        <div id="setupChoiceView" style="display: none;">
            <div class="setup-view">
                <div class="setup-title">Set Up Your Budget</div>
                <div class="setup-subtitle">Pick the setup style that feels right. You can switch later.</div>
                <div class="setup-grid">
                    <button class="setup-option" id="quickSetupBtn" type="button">
                        <h3>Quick Setup</h3>
                        <p>Essential questions only for a clean first budget with less friction.</p>
                        <span class="setup-chip">About 5 minutes</span>
                    </button>
                    <button class="setup-option" id="detailedSetupBtn" type="button">
                        <h3>Detailed Setup</h3>
                        <p>Full category breakdown for the most detailed dashboard and planning.</p>
                        <span class="setup-chip">About 15 minutes</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Questionnaire View -->
        <div id="questionnaireView" style="display: none;">
            <div class="question-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
                <div class="mode-badge" id="modeBadge"></div>
                <div class="question-title" id="questionTitle"></div>
                <div class="question-text" id="questionText"></div>
                <div class="question-subtext" id="questionSubtext"></div>
                <div class="input-group">
                    <input type="number" class="amount-input" id="amountInput" placeholder="$0" min="0" step="0.01">
                </div>
                <!-- Quick Entry Buttons -->
                <div id="quickEntryButtons" style="display: none; margin: 20px 0; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="quick-btn" data-amount="0">$0</button>
                    <button class="quick-btn" data-amount="50">$50</button>
                    <button class="quick-btn" data-amount="100">$100</button>
                    <button class="quick-btn" data-amount="200">$200</button>
                    <button class="quick-btn" data-amount="500">$500</button>
                    <button class="quick-btn" data-amount="1000">$1,000</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button class="skip-btn back-btn" id="backBtn">Back</button>
                    <button class="skip-btn" id="skipBtn">Skip question</button>
                    <button class="next-btn" id="nextBtn">Next</button>
                </div>
            </div>
        </div>

        <!-- Summary View -->
        <div id="summaryView" style="display: none;">
            <div class="summary-container">
                <div class="summary-title">Your Spending Summary</div>
                <div id="summaryContent"></div>
                <div class="total-section">
                    <div class="total-text" id="totalAmount"></div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="edit-btn" id="editBtn">Edit Spending Categories</button>
                    <button class="next-btn" id="goDashboardBtn" type="button">Go to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Spending categories
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source", question: "What is your main source of income? This is your primary job or business that provides most of your money.", type: "select", options: ["Salary/Wages", "Hourly Pay", "Commission", "Business Income", "Self-Employment", "Social Security", "Disability Benefits", "Pension", "Other"] },
            { label: "Primary Monthly Income", question: "How much do you earn monthly from your main income source? Enter your average monthly amount from your primary job/business.", type: "number" },
            { label: "Has Additional Income", question: "Do you have any other regular monthly income sources? These are additional sources that pay you every month (part-time jobs, rental income, etc.).", type: "yesno" },
            { label: "Additional Income Sources", question: "What other regular monthly income sources do you have? Select all that apply.", type: "multiselect", options: ["Part-time Job", "Freelance Work", "Rental Income", "Interest/Dividends", "Child Support", "Alimony", "Tips/Gratuities", "Overtime Pay", "Online Business", "Other"] },
            { label: "Additional Monthly Income", question: "How much do you earn monthly from each additional source? Enter the total monthly amount from all additional sources combined.", type: "number" },
            { label: "Total Monthly Income", question: "What is your total monthly regular income? This is the sum of all your monthly income sources.", type: "calculated" },
            { label: "Has Irregular Income", question: "Do you receive any irregular income throughout the year? These are one-time or occasional payments (bonuses, seasonal work, etc.).", type: "yesno" },
            { label: "Irregular Income Types", question: "What types of irregular income do you receive? Select all that apply.", type: "multiselect", options: ["Bonuses", "Seasonal Work", "Capital Gains", "Royalties", "Severance Pay", "Unemployment Benefits", "Workers Compensation", "Lottery/Gambling", "Other"] },
            { label: "Annual Irregular Income", question: "How much do you earn annually from irregular income? Enter the total amount you receive per year from all irregular sources.", type: "number" },
            { label: "Total Annual Income", question: "What is your total annual income? This helps us understand your complete financial picture.", type: "calculated" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage", question: "What is your monthly rent or mortgage payment?" },
            { label: "Mortgage Interest Rate", question: "What is the interest rate on your mortgage loan? (Enter as a percentage, e.g., 3.5)", type: "number" },
            { label: "Mortgage Principal", question: "What is the principal amount on your mortgage? (Monthly principal payment)", type: "number" },
            { label: "Property Taxes", question: "How much do you pay monthly for property taxes?" },
            { label: "Home Insurance", question: "What is your monthly home insurance cost?" },
            { label: "Utilities (Electricity, Water, Gas)", question: "How much do you spend monthly on utilities?" },
            { label: "Internet & Phone", question: "What is your monthly internet and phone bill?" },
            { label: "Maintenance/Repairs", question: "How much do you budget monthly for home maintenance?" },
            { label: "HOA Fees", question: "Do you pay monthly HOA fees? If so, how much?" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease", question: "What is your monthly car payment or lease?" },
            { label: "Gas/Fuel", question: "How much do you spend monthly on gas or fuel?" },
            { label: "Car Insurance", question: "What is your monthly car insurance premium?" },
            { label: "Maintenance/Repairs", question: "How much do you budget monthly for car maintenance?" },
            { label: "Public Transportation", question: "How much do you spend monthly on public transportation?" },
            { label: "Parking Fees", question: "How much do you spend monthly on parking?" },
            { label: "Uber/Lyft", question: "How much do you spend monthly on ride-sharing services?" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries", question: "How much do you spend monthly on groceries?" },
            { label: "Restaurants", question: "How much do you spend monthly on restaurants?" },
            { label: "Fast Food", question: "How much do you spend monthly on fast food?" },
            { label: "Coffee Shops", question: "How much do you spend monthly on coffee shops?" },
            { label: "Food Delivery", question: "How much do you spend monthly on food delivery?" },
            { label: "Alcohol/Bars", question: "How much do you spend monthly on alcohol and bars?" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance", question: "What is your monthly health insurance premium?" },
            { label: "Doctor Visits", question: "How much do you spend monthly on doctor visits?" },
            { label: "Prescriptions", question: "How much do you spend monthly on prescriptions?" },
            { label: "Dental Care", question: "How much do you spend monthly on dental care?" },
            { label: "Vision Care", question: "How much do you spend monthly on vision care?" },
            { label: "Gym Membership", question: "How much do you spend monthly on gym membership?" },
            { label: "Haircuts/Salon", question: "How much do you spend monthly on haircuts and salon services?" },
            { label: "Personal Hygiene Products", question: "How much do you spend monthly on personal hygiene products?" },
            { label: "Clothing/Shoes", question: "How much do you spend monthly on clothing and shoes?" },
            { label: "Cosmetics/Beauty", question: "How much do you spend monthly on cosmetics and beauty products?" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services", question: "How much do you spend monthly on streaming services (Netflix, Hulu, etc.)?" },
            { label: "Movies/Theater", question: "How much do you spend monthly on movies and theater?" },
            { label: "Concerts/Events", question: "How much do you spend monthly on concerts and events?" },
            { label: "Books/Magazines", question: "How much do you spend monthly on books and magazines?" },
            { label: "Video Games", question: "How much do you spend monthly on video games?" },
            { label: "Hobbies", question: "How much do you spend monthly on hobbies?" },
            { label: "Vacations", question: "How much do you budget monthly for vacations?" },
            { label: "Hotels", question: "How much do you spend monthly on hotels?" },
            { label: "Flights", question: "How much do you spend monthly on flights?" },
            { label: "Car Rentals", question: "How much do you spend monthly on car rentals?" },
            { label: "Travel Insurance", question: "How much do you spend monthly on travel insurance?" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards", question: "How much do you pay monthly on credit cards?" },
            { label: "Student Loans", question: "How much do you pay monthly on student loans?" },
            { label: "Personal Loans", question: "How much do you pay monthly on personal loans?" },
            { label: "Medical Debt", question: "How much do you pay monthly on medical debt?" },
            { label: "Emergency Fund", question: "How much do you save monthly for emergency fund?" },
            { label: "Retirement Savings", question: "How much do you save monthly for retirement?" },
            { label: "Investment Accounts", question: "How much do you invest monthly?" },
            { label: "College Savings", question: "How much do you save monthly for college?" }
        ]},
        { title: "Other", items: [
            { label: "Tuition", question: "How much do you pay monthly for tuition?" },
            { label: "Books/Supplies", question: "How much do you spend monthly on books and supplies?" },
            { label: "Courses/Certifications", question: "How much do you spend monthly on courses and certifications?" },
            { label: "Birthday/Holiday Gifts", question: "How much do you spend monthly on gifts?" },
            { label: "Charitable Donations", question: "How much do you donate monthly to charity?" },
            { label: "Wedding Gifts", question: "How much do you spend monthly on wedding gifts?" },
            { label: "Life Insurance", question: "How much do you pay monthly for life insurance?" },
            { label: "Disability Insurance", question: "How much do you pay monthly for disability insurance?" },
            { label: "Pet Insurance", question: "How much do you pay monthly for pet insurance?" },
            { label: "Pet Food", question: "How much do you spend monthly on pet food?" },
            { label: "Vet Visits", question: "How much do you spend monthly on vet visits?" },
            { label: "Pet Supplies", question: "How much do you spend monthly on pet supplies?" }
        ]}
    ];

    const QUICK_SETUP_FIELDS = new Set([
        'Primary Income Source',
        'Primary Monthly Income',
        'Has Additional Income',
        'Additional Monthly Income',
        'Total Monthly Income',
        'Has Irregular Income',
        'Annual Irregular Income',
        'Total Annual Income',
        'Rent/Mortgage',
        'Utilities (Electricity, Water, Gas)',
        'Internet & Phone',
        'Car Payment/Lease',
        'Gas/Fuel',
        'Car Insurance',
        'Public Transportation',
        'Groceries',
        'Restaurants',
        'Food Delivery',
        'Health Insurance',
        'Streaming Services',
        'Hobbies',
        'Credit Cards',
        'Student Loans',
        'Personal Loans',
        'Medical Debt',
        'Emergency Fund',
        'Retirement Savings',
        'Investment Accounts'
    ]);

    let currentQuestionIndex = 0;
    let userResponses = {};
    let currentUser = null;
    let questionnaireMode = 'quick';
    let questionFlow = [];

    // DOM elements
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const setupChoiceView = document.getElementById('setupChoiceView');
    const quickSetupBtn = document.getElementById('quickSetupBtn');
    const detailedSetupBtn = document.getElementById('detailedSetupBtn');
    const questionnaireView = document.getElementById('questionnaireView');
    const summaryView = document.getElementById('summaryView');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const modeBadge = document.getElementById('modeBadge');
    const questionTitle = document.getElementById('questionTitle');
    const questionText = document.getElementById('questionText');
    const questionSubtext = document.getElementById('questionSubtext');
    const skipBtn = document.getElementById('skipBtn');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const summaryContent = document.getElementById('summaryContent');
    const totalAmount = document.getElementById('totalAmount');
    const editBtn = document.getElementById('editBtn');
    const goDashboardBtn = document.getElementById('goDashboardBtn');

    auth.onAuthStateChanged(function(user) {
        if (user) {
            currentUser = user;
            userEmail.textContent = user.email;
            loadUserData();
        } else {
            window.location.href = 'login.html';
        }
    });

    async function loadUserData() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).collection('spending').doc('categories').get();
            if (doc.exists) {
                userResponses = doc.data() || {};
                showSummaryView();
            } else {
                userResponses = {};
                showSetupChoiceView();
            }
        } catch (error) {
            console.error('Error loading data:', error);
            userResponses = {};
            showSetupChoiceView();
        }
    }

    async function saveUserData() {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('spending').doc('categories').set(userResponses);
        } catch (error) {
            console.error('Error saving data:', error);
        }
    }

    function showSetupChoiceView() {
        setupChoiceView.style.display = 'block';
        questionnaireView.style.display = 'none';
        summaryView.style.display = 'none';
    }

    function showQuestionnaireView() {
        setupChoiceView.style.display = 'none';
        questionnaireView.style.display = 'block';
        summaryView.style.display = 'none';
        showCurrentQuestion();
    }

    function showSummaryView() {
        setupChoiceView.style.display = 'none';
        questionnaireView.style.display = 'none';
        summaryView.style.display = 'block';
        displaySummary();
    }

    function startQuestionnaire(mode) {
        questionnaireMode = mode;
        questionFlow = buildQuestionFlow(mode);
        currentQuestionIndex = 0;
        showQuestionnaireView();
    }

    function buildQuestionFlow(mode) {
        const flow = [];
        for (const category of spendingCategories) {
            for (const item of category.items) {
                const includeInMode = mode === 'detailed' || QUICK_SETUP_FIELDS.has(item.label) || item.type === 'calculated';
                if (includeInMode) {
                    flow.push({ category, item });
                }
            }
        }
        return flow;
    }

    function toNumber(value) {
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function shouldSkipQuestion(category, item) {
        if (item.label === 'Additional Income Sources' || item.label === 'Additional Monthly Income') {
            return userResponses['Has Additional Income'] === 'no';
        }

        if (item.label === 'Irregular Income Types' || item.label === 'Annual Irregular Income') {
            return userResponses['Has Irregular Income'] === 'no';
        }

        if (item.label === 'Mortgage Interest Rate' || item.label === 'Mortgage Principal') {
            const rentMortgage = toNumber(userResponses['Rent/Mortgage']);
            return rentMortgage <= 0;
        }

        if (category.title === 'Transportation' && (item.label === 'Gas/Fuel' || item.label === 'Car Insurance' || item.label === 'Maintenance/Repairs')) {
            const carPayment = toNumber(userResponses['Car Payment/Lease']);
            return carPayment <= 0 && userResponses['Car Payment/Lease'] !== undefined && userResponses['Car Payment/Lease'] !== 'skipped';
        }

        return false;
    }

    function getCurrentQuestionEntry() {
        while (currentQuestionIndex < questionFlow.length) {
            const entry = questionFlow[currentQuestionIndex];
            if (!shouldSkipQuestion(entry.category, entry.item)) {
                return entry;
            }
            if (userResponses[entry.item.label] === undefined) {
                userResponses[entry.item.label] = 'skipped';
            }
            currentQuestionIndex += 1;
        }
        return null;
    }

    function getProgressInfo() {
        let visibleTotal = 0;
        let currentVisibleIndex = 0;
        for (let i = 0; i < questionFlow.length; i += 1) {
            const entry = questionFlow[i];
            if (!shouldSkipQuestion(entry.category, entry.item)) {
                visibleTotal += 1;
                if (i <= currentQuestionIndex) {
                    currentVisibleIndex = visibleTotal;
                }
            }
        }
        return {
            current: Math.max(1, currentVisibleIndex),
            total: Math.max(1, visibleTotal)
        };
    }

    function hasNextVisibleQuestion() {
        for (let i = currentQuestionIndex + 1; i < questionFlow.length; i += 1) {
            const entry = questionFlow[i];
            if (!shouldSkipQuestion(entry.category, entry.item)) {
                return true;
            }
        }
        return false;
    }

    function renderCurrentInput(item) {
        const inputGroup = document.querySelector('.input-group');
        inputGroup.innerHTML = '';
        const quickEntryButtons = document.getElementById('quickEntryButtons');

        if (item.type === 'select') {
            const select = document.createElement('select');
            select.className = 'amount-input';
            select.id = 'amountInput';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select an option...';
            select.appendChild(defaultOption);

            item.options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            select.value = userResponses[item.label] || '';
            inputGroup.appendChild(select);
            quickEntryButtons.style.display = 'none';
        } else if (item.type === 'yesno') {
            const buttonGroup = document.createElement('div');
            buttonGroup.style.display = 'flex';
            buttonGroup.style.gap = '10px';
            buttonGroup.style.justifyContent = 'center';

            const currentValue = userResponses[item.label];
            const yesBtn = document.createElement('button');
            yesBtn.type = 'button';
            yesBtn.className = `next-btn ${currentValue === 'yes' ? 'quick-btn active' : ''}`;
            yesBtn.textContent = 'Yes';
            yesBtn.onclick = () => {
                userResponses[item.label] = 'yes';
                handleNext();
            };

            const noBtn = document.createElement('button');
            noBtn.type = 'button';
            noBtn.className = `next-btn ${currentValue === 'no' ? 'quick-btn active' : ''}`;
            noBtn.textContent = 'No';
            noBtn.onclick = () => {
                userResponses[item.label] = 'no';
                handleNext();
            };

            buttonGroup.appendChild(yesBtn);
            buttonGroup.appendChild(noBtn);
            inputGroup.appendChild(buttonGroup);
            quickEntryButtons.style.display = 'none';
        } else if (item.type === 'multiselect') {
            const selectedValues = Array.isArray(userResponses[item.label]) ? userResponses[item.label] : [];
            const checkboxGroup = document.createElement('div');
            checkboxGroup.style.textAlign = 'left';
            checkboxGroup.style.maxHeight = '220px';
            checkboxGroup.style.overflowY = 'auto';
            checkboxGroup.style.padding = '8px 12px';
            checkboxGroup.style.background = '#2c2c2c';
            checkboxGroup.style.borderRadius = '12px';

            item.options.forEach(option => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '10px';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${item.label}-${option}`;
                checkbox.value = option;
                checkbox.checked = selectedValues.includes(option);

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = option;
                label.style.marginLeft = '10px';
                label.style.color = '#ccc';

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxGroup.appendChild(checkboxDiv);
            });

            inputGroup.appendChild(checkboxGroup);
            quickEntryButtons.style.display = 'none';
        } else if (item.type === 'calculated') {
            const displayDiv = document.createElement('div');
            displayDiv.className = 'amount-input';
            displayDiv.style.backgroundColor = '#444';
            displayDiv.style.border = '1px solid #666';

            let calculatedValue = 0;
            if (item.label === 'Total Monthly Income') {
                const primary = toNumber(userResponses['Primary Monthly Income']);
                const additional = toNumber(userResponses['Additional Monthly Income']);
                calculatedValue = primary + additional;
            } else if (item.label === 'Total Annual Income') {
                const monthly = toNumber(userResponses['Total Monthly Income']);
                const irregular = toNumber(userResponses['Annual Irregular Income']);
                calculatedValue = (monthly * 12) + irregular;
            }

            userResponses[item.label] = calculatedValue.toFixed(2);
            displayDiv.textContent = `$${calculatedValue.toFixed(2)}`;
            inputGroup.appendChild(displayDiv);
            quickEntryButtons.style.display = 'none';
        } else {
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'amount-input';
            input.id = 'amountInput';
            input.placeholder = '$0';
            input.min = '0';
            input.step = '0.01';
            input.value = userResponses[item.label] && userResponses[item.label] !== 'skipped' ? userResponses[item.label] : '';
            inputGroup.appendChild(input);

            quickEntryButtons.style.display = 'flex';
            const quickBtns = quickEntryButtons.querySelectorAll('.quick-btn');
            quickBtns.forEach(btn => {
                btn.classList.remove('active');
                btn.onclick = () => {
                    const amount = btn.getAttribute('data-amount');
                    input.value = amount;
                    quickBtns.forEach(button => button.classList.remove('active'));
                    btn.classList.add('active');
                };
            });
        }

        const input = document.getElementById('amountInput');
        if (input) input.focus();
    }

    function showCurrentQuestion() {
        const entry = getCurrentQuestionEntry();
        if (!entry) {
            showSummaryView();
            saveUserData();
            return;
        }

        const { category, item } = entry;
        const progressInfo = getProgressInfo();
        const progress = (progressInfo.current / progressInfo.total) * 100;

        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Question ${progressInfo.current} of ${progressInfo.total}`;
        modeBadge.textContent = questionnaireMode === 'quick' ? 'Quick Setup Mode' : 'Detailed Setup Mode';
        questionTitle.textContent = category.title;
        questionText.textContent = item.question || `Enter your monthly amount for ${item.label}.`;
        questionSubtext.textContent = `Field: ${item.label}`;
        backBtn.disabled = currentQuestionIndex === 0;
        nextBtn.textContent = hasNextVisibleQuestion() ? 'Next' : 'Finish';

        renderCurrentInput(item);
    }

    function saveCurrentQuestionValue() {
        const entry = questionFlow[currentQuestionIndex];
        if (!entry) return;
        const item = entry.item;

        if (item.type === 'select') {
            const select = document.getElementById('amountInput');
            userResponses[item.label] = select && select.value ? select.value : 'skipped';
            return;
        }

        if (item.type === 'multiselect') {
            const checkboxes = document.querySelectorAll('.input-group input[type="checkbox"]');
            const selected = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) selected.push(checkbox.value);
            });
            userResponses[item.label] = selected.length > 0 ? selected : 'skipped';
            return;
        }

        if (item.type === 'calculated') {
            return;
        }

        if (item.type === 'yesno') {
            if (!userResponses[item.label]) {
                userResponses[item.label] = 'skipped';
            }
            return;
        }

        const input = document.getElementById('amountInput');
        if (!input || input.value.trim() === '') {
            userResponses[item.label] = 'skipped';
        } else {
            userResponses[item.label] = input.value.trim();
        }
    }

    function handleNext() {
        saveCurrentQuestionValue();
        currentQuestionIndex += 1;
        saveUserData();
        showCurrentQuestion();
    }

    function handleBack() {
        if (currentQuestionIndex === 0) return;
        currentQuestionIndex -= 1;
        while (currentQuestionIndex > 0) {
            const entry = questionFlow[currentQuestionIndex];
            if (!entry || !shouldSkipQuestion(entry.category, entry.item)) break;
            currentQuestionIndex -= 1;
        }
        showCurrentQuestion();
    }

    function handleSkip() {
        const entry = questionFlow[currentQuestionIndex];
        if (entry) {
            userResponses[entry.item.label] = 'skipped';
        }
        currentQuestionIndex += 1;
        saveUserData();
        showCurrentQuestion();
    }

    function displaySummary() {
        let totalIncome = 0;
        let totalSpendingMonthly = 0;

        for (const category of spendingCategories) {
            if (category.title === 'Income') {
                const monthlyIncome = toNumber(userResponses['Total Monthly Income']);
                const irregularIncome = toNumber(userResponses['Annual Irregular Income']);
                totalIncome = (monthlyIncome * 12) + irregularIncome;
                continue;
            }

            for (const item of category.items) {
                if (item.label === 'Mortgage Principal' || item.label === 'Mortgage Interest Rate') continue;
                const value = userResponses[item.label];
                const numeric = toNumber(value);
                if (value && value !== 'skipped' && numeric > 0) {
                    totalSpendingMonthly += numeric;
                }
            }

            if (category.title === 'Housing') {
                const mortgagePrincipal = toNumber(userResponses['Mortgage Principal']);
                if (mortgagePrincipal > 0) totalSpendingMonthly += mortgagePrincipal;
            }
        }

        const categoryColors = {
            'Income': '#4caf50',
            'Housing': '#2196f3',
            'Transportation': '#ff9800',
            'Food & Dining': '#e91e63',
            'Personal & Health': '#9c27b0',
            'Entertainment & Lifestyle': '#00bcd4',
            'Financial Obligations': '#ff5722',
            'Other': '#607d8b'
        };

        const answeredCount = Object.values(userResponses).filter(value => value !== undefined && value !== null && value !== '' && value !== 'skipped').length;

        let html = '<div style="text-align: center; margin-bottom: 20px;">';
        html += `<div style="font-size: 15px; color: #81c9ff; margin-bottom: 10px;">${questionnaireMode === 'quick' ? 'Quick setup complete' : 'Detailed setup complete'} â€¢ ${answeredCount} answers saved</div>`;
        html += `<div style="font-size: 24px; color: #4caf50; margin-bottom: 10px;">Total Annual Income: $${Math.round(totalIncome).toLocaleString()}</div>`;
        html += '</div>';

        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

        for (const category of spendingCategories) {
            if (category.title === 'Income') continue;
            let categoryTotal = 0;
            const categoryItems = [];

            for (const item of category.items) {
                if (item.label === 'Mortgage Principal' || item.label === 'Mortgage Interest Rate') continue;
                const value = userResponses[item.label];
                const numValue = toNumber(value);
                if (value && value !== 'skipped' && numValue > 0) {
                    categoryTotal += numValue;
                    categoryItems.push({ name: item.label, value: numValue });
                }
            }

            if (category.title === 'Housing') {
                const mortgagePrincipal = toNumber(userResponses['Mortgage Principal']);
                if (mortgagePrincipal > 0) {
                    categoryTotal += mortgagePrincipal;
                    categoryItems.push({ name: 'Mortgage Principal', value: mortgagePrincipal });
                }
            }

            if (categoryTotal > 0) {
                const percentage = totalIncome > 0 ? ((categoryTotal * 12) / totalIncome * 100).toFixed(1) : '0.0';
                const color = categoryColors[category.title] || '#666';
                html += `<div style="background: #333; border-radius: 10px; padding: 15px; border-left: 4px solid ${color};">`;
                html += `<div style="font-size: 18px; font-weight: bold; color: ${color}; margin-bottom: 10px;">${category.title}</div>`;
                html += `<div style="font-size: 14px; color: #ccc; margin-bottom: 15px;">Annual: $${Math.round(categoryTotal * 12).toLocaleString()} (${percentage}%)</div>`;
                html += '<div style="font-size: 12px; color: #999;">';
                for (const item of categoryItems) {
                    const subPercentage = totalIncome > 0 ? ((item.value * 12) / totalIncome * 100).toFixed(1) : '0.0';
                    html += `<div style="margin: 5px 0; padding: 5px; background: #444; border-radius: 5px;">`;
                    html += `<span style="color: #ccc;">${item.name}</span>`;
                    html += `<span style="float: right; color: ${color};">$${Math.round(item.value * 12).toLocaleString()} (${subPercentage}%)</span>`;
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';
            }
        }

        html += '</div>';
        const annualSpending = totalSpendingMonthly * 12;
        const surplus = totalIncome - annualSpending;
        const surplusColor = surplus >= 0 ? '#4caf50' : '#ff5252';
        const surplusText = surplus >= 0 ? 'Surplus' : 'Deficit';

        html += '<div style="margin-top: 30px; padding: 20px; background: #333; border-radius: 10px;">';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">';
        html += `<div style="text-align: center;"><div style="font-size: 18px; color: #4caf50;">Annual Income</div><div style="font-size: 24px; color: #4caf50; font-weight: bold;">$${Math.round(totalIncome).toLocaleString()}</div></div>`;
        html += `<div style="text-align: center;"><div style="font-size: 18px; color: #ff5252;">Annual Spending</div><div style="font-size: 24px; color: #ff5252; font-weight: bold;">$${Math.round(annualSpending).toLocaleString()}</div></div>`;
        html += '</div>';
        html += `<div style="text-align: center; font-size: 24px; color: ${surplusColor}; font-weight: bold;">${surplusText}: $${Math.abs(Math.round(surplus)).toLocaleString()}</div>`;
        html += '</div>';

        summaryContent.innerHTML = html;
        totalAmount.textContent = `${surplusText}: $${Math.abs(Math.round(surplus)).toLocaleString()} / year`;
    }

    quickSetupBtn.addEventListener('click', () => startQuestionnaire('quick'));
    detailedSetupBtn.addEventListener('click', () => startQuestionnaire('detailed'));
    nextBtn.addEventListener('click', handleNext);
    backBtn.addEventListener('click', handleBack);
    skipBtn.addEventListener('click', handleSkip);
    editBtn.addEventListener('click', showSetupChoiceView);
    goDashboardBtn.addEventListener('click', () => { window.location.href = 'dashboard.html'; });

    document.addEventListener('keydown', function(event) {
        if (questionnaireView.style.display !== 'block') return;
        if (event.key === 'Enter') {
            event.preventDefault();
            handleNext();
        }
    });

    logoutBtn.onclick = function() {
        auth.signOut();
    };
    </script>
</body>
</html> 
