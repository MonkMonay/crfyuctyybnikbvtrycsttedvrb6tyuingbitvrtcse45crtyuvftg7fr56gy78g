<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" />
    <title>Dashboard - BonoBudget</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
         crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-radius: 0 0 20px 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .nav {
            display: flex;
            gap: 30px;
        }
        
        .nav-item {
            color: #ccc;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #333;
            color: #fff;
        }
        
        .nav-item.active {
            background: #4caf50;
            color: #fff;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-email {
            color: #ccc;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: #ff5252;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        
        .welcome-text {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        /* Google Ads Styling */
        .ads-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }
        
        .ad-sidebar {
            width: 300px;
            min-height: 600px;
            background: #222;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .ad-banner {
            width: 100%;
            height: 90px;
            background: #333;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ccc;
        }
        
        .main-content {
            flex: 1;
            background: #222;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .panel {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 24px;
        }

        .panel-title {
            margin: 0 0 16px;
            font-size: 20px;
            color: #4caf50;
        }

        .sankey-container {
            width: 100%;
            min-height: 430px;
            position: relative;
        }

        .empty-state {
            background: #1c1c1c;
            border: 1px dashed #444;
            border-radius: 12px;
            color: #bbb;
            padding: 24px;
            text-align: center;
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .checklist {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checklist-item {
            background: #333;
            border: 1px solid #3f3f3f;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .checklist-item strong {
            display: block;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .checklist-item span {
            font-size: 12px;
            color: #aaa;
            line-height: 1.35;
        }

        .status-pill {
            border-radius: 999px;
            padding: 3px 9px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }

        .status-done {
            background: rgba(76, 175, 80, 0.18);
            color: #7de281;
            border: 1px solid rgba(76, 175, 80, 0.45);
        }

        .status-progress {
            background: rgba(255, 193, 7, 0.16);
            color: #ffda68;
            border: 1px solid rgba(255, 193, 7, 0.45);
        }

        .status-next {
            background: rgba(33, 150, 243, 0.16);
            color: #81c9ff;
            border: 1px solid rgba(33, 150, 243, 0.45);
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .ad-sidebar {
                width: 100%;
                min-height: auto;
            }

            .checklist-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">Bonobudget</div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="welcome-text" id="welcome"></div>
        
        <div class="content-wrapper">
            <!-- Left Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <h2 style="color:#4caf50;text-align:center;margin-top:10px;">Your Financial Overview</h2>
                
                <!-- Summary Cards -->
                <div id="summaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <!-- Time Period Display -->
                <div id="timePeriod" style="text-align: center; color: #999; margin-bottom: 20px; font-size: 14px;">
                    Annual Overview
                </div>

                <div class="panel" style="margin-bottom: 30px;">
                    <h3 class="panel-title">Money Flow (Sankey)</h3>
                    <div id="chartEmptyState" class="empty-state" style="display: none;"></div>
                    <div id="sankeyChart" class="sankey-container"></div>
                </div>
                
                <!-- Charts Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <!-- Income Chart -->
                    <div class="panel">
                        <h3 style="color: #4caf50; text-align: center; margin-bottom: 20px; font-size: 20px;">Income Sources</h3>
                        <div id="incomeChart" style="width: 100%; height: 350px;"></div>
                        <div id="incomeLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                    
                    <!-- Expenses Chart -->
                    <div class="panel">
                        <h3 style="color: #ff5252; text-align: center; margin-bottom: 20px; font-size: 20px;">Expense Categories</h3>
                        <div id="expenseChart" style="width: 100%; height: 350px;"></div>
                        <div id="expenseLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                </div>

                <div class="checklist-grid">
                    <div class="panel">
                        <h3 class="panel-title">Next Best Actions</h3>
                        <ul id="actionChecklist" class="checklist"></ul>
                    </div>
                    <div class="panel">
                        <h3 class="panel-title">Budget App Excellence Roadmap</h3>
                        <ul id="productRoadmap" class="checklist"></ul>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        </div>
        
        <!-- Bottom Banner Ad -->
        <div style="margin-top: 30px; text-align: center;">
            <div class="ad-banner" style="height: 120px; margin: 0 auto; max-width: 728px;">
                <!-- Google AdSense - Bottom Banner -->
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                     crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2901233728197269"
                     data-ad-slot="YOUR_AD_SLOT_ID"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        #incomeChart, #expenseChart {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .chart-tooltip {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        @media (max-width: 1200px) {
            .main-content > div:last-child {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    const chartEmptyState = document.getElementById('chartEmptyState');
    const sankeyChartContainer = document.getElementById('sankeyChart');
    let latestModel = null;
    let sankeyResizeTimer = null;
    let isSankeyResizeBound = false;

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });

    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function toAmount(value) {
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function showChartState(message) {
        chartEmptyState.style.display = 'block';
        chartEmptyState.textContent = message;
        sankeyChartContainer.innerHTML = '';
    }

    function hideChartState() {
        chartEmptyState.style.display = 'none';
        chartEmptyState.textContent = '';
    }

    function renderSummaryMessage(message) {
        document.getElementById('summaryCards').innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">${message}</div>`;
        document.getElementById('incomeChart').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
        document.getElementById('expenseChart').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
        document.getElementById('incomeLegend').innerHTML = '';
        document.getElementById('expenseLegend').innerHTML = '';
    }

    function buildFinancialModel(data) {
        const incomeSources = [];
        const primaryIncome = toAmount(data['Primary Monthly Income']);
        const additionalIncome = toAmount(data['Additional Monthly Income']);
        const irregularIncome = toAmount(data['Annual Irregular Income']);
        const fallbackMonthlyIncome = toAmount(data['Total Monthly Income']);
        const fallbackAnnualIncome = toAmount(data['Total Annual Income']);

        if (primaryIncome > 0) {
            incomeSources.push({
                name: data['Primary Income Source'] || 'Primary Income',
                value: primaryIncome * 12
            });
        }
        if (additionalIncome > 0) {
            incomeSources.push({
                name: 'Additional Income',
                value: additionalIncome * 12
            });
        }
        if (irregularIncome > 0) {
            incomeSources.push({
                name: 'Irregular Income',
                value: irregularIncome
            });
        }
        if (incomeSources.length === 0 && fallbackMonthlyIncome > 0) {
            incomeSources.push({ name: 'Total Income', value: fallbackMonthlyIncome * 12 });
        }
        if (incomeSources.length === 0 && fallbackAnnualIncome > 0) {
            incomeSources.push({ name: 'Total Income', value: fallbackAnnualIncome });
        }

        const categoryTotals = {};
        const subcategoryTotals = {};
        const savingsItems = new Set(['Emergency Fund', 'Retirement Savings', 'Investment Accounts', 'College Savings']);
        const nonSpendFields = new Set(['Mortgage Interest Rate']);
        let totalSavingsMonthly = 0;
        let answeredCount = 0;

        Object.keys(data || {}).forEach(key => {
            const value = data[key];
            if (value !== undefined && value !== null && value !== '' && value !== 'skipped') {
                answeredCount += 1;
            }
        });

        for (const category of spendingCategories) {
            if (category.title === 'Income') continue;

            let categoryTotal = 0;
            for (const item of category.items) {
                if (item.label === 'Mortgage Principal' || nonSpendFields.has(item.label)) continue;
                const raw = data[item.label];
                const numeric = toAmount(raw);
                if (!raw || raw === 'skipped' || numeric <= 0) continue;

                if (savingsItems.has(item.label)) {
                    totalSavingsMonthly += numeric;
                } else {
                    categoryTotal += numeric;
                }
                subcategoryTotals[item.label] = numeric;
            }

            if (category.title === 'Housing') {
                const mortgagePrincipal = toAmount(data['Mortgage Principal']);
                if (mortgagePrincipal > 0) {
                    categoryTotal += mortgagePrincipal;
                    subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                }
            }

            if (categoryTotal > 0) {
                categoryTotals[category.title] = categoryTotal;
            }
        }

        if (totalSavingsMonthly > 0) {
            categoryTotals['Savings'] = totalSavingsMonthly;
        }

        const totalIncome = incomeSources.reduce((sum, source) => sum + source.value, 0);
        const totalExpenses = Object.values(categoryTotals).reduce((sum, monthly) => sum + (monthly * 12), 0);
        const surplus = totalIncome - totalExpenses;

        return {
            incomeSources,
            categoryTotals,
            subcategoryTotals,
            totalIncome,
            totalExpenses,
            surplus,
            answeredCount
        };
    }

    function getChartTooltip() {
        let tooltip = d3.select('#chartTooltip');
        if (tooltip.empty()) {
            tooltip = d3.select('body').append('div')
                .attr('id', 'chartTooltip')
                .attr('class', 'chart-tooltip')
                .style('opacity', 0)
                .style('position', 'absolute')
                .style('background', 'rgba(0, 0, 0, 0.9)')
                .style('color', '#fff')
                .style('padding', '12px')
                .style('border-radius', '8px')
                .style('pointer-events', 'none')
                .style('font-size', '13px')
                .style('z-index', '10000');
        }
        return tooltip;
    }

    function bindSankeyResize() {
        if (isSankeyResizeBound) return;
        isSankeyResizeBound = true;
        window.addEventListener('resize', () => {
            clearTimeout(sankeyResizeTimer);
            sankeyResizeTimer = setTimeout(() => {
                if (latestModel && latestModel.totalIncome > 0 && Object.keys(latestModel.categoryTotals).length > 0) {
                    createSankeyChart(latestModel);
                }
            }, 180);
        });
    }

    async function loadSankeyData(uid) {
        showChartState('Loading your money flow...');
        renderProductRoadmap();
        try {
            const doc = await db.collection('users').doc(uid).collection('spending').doc('categories').get();
            if (!doc.exists) {
                renderSummaryMessage('No spending data available. Complete the Bank setup to unlock your dashboard.');
                renderActionChecklist(null);
                showChartState('No spending data available yet. Complete your Bank setup first.');
                return;
            }

            const data = doc.data() || {};
            window.sankeyData = data;
            const model = buildFinancialModel(data);
            latestModel = model;

            if (model.totalIncome <= 0) {
                renderSummaryMessage('No income data found. Complete the income questions in Bank setup.');
                renderActionChecklist(model);
                showChartState('No income data found. Complete the income part of the Bank setup.');
                return;
            }

            if (Object.keys(model.categoryTotals).length === 0) {
                renderSummaryMessage('No expense data found. Add monthly spending in the Bank setup.');
                renderActionChecklist(model);
                showChartState('No spending data found. Add expenses in Bank setup to render the Sankey flow.');
                return;
            }

            hideChartState();
            createOverviewDashboard(model);
            renderActionChecklist(model);
            bindSankeyResize();
        } catch (error) {
            console.error('Error loading data:', error);
            renderSummaryMessage('Error loading your dashboard. Please refresh and try again.');
            renderActionChecklist(null);
            showChartState('We could not load your financial data. Please refresh and try again.');
        }
    }

    function createOverviewDashboard(model) {
        const { incomeSources, categoryTotals, totalIncome, totalExpenses, surplus } = model;

        const summaryCards = document.getElementById('summaryCards');
        summaryCards.innerHTML = `
            <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Income</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.round(totalIncome).toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, #ff5252 0%, #e53935 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Expenses</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.round(totalExpenses).toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, ${surplus >= 0 ? '#2196f3' : '#ff7043'} 0%, ${surplus >= 0 ? '#1e88e5' : '#f4511e'} 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">${surplus >= 0 ? 'Surplus' : 'Deficit'}</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.abs(Math.round(surplus)).toLocaleString()}</div>
                ${surplus < 0 ? '<div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">Spending currently exceeds income</div>' : ''}
            </div>
        `;

        createSankeyChart(model);
        createDonutChart('incomeChart', 'incomeLegend', incomeSources, totalIncome, 'Income', '#4caf50');
        const expenseData = Object.keys(categoryTotals).map(category => ({
            name: category,
            value: categoryTotals[category] * 12
        }));
        createDonutChart('expenseChart', 'expenseLegend', expenseData, totalExpenses, 'Expenses', '#ff5252');
    }

    function createSankeyChart(model) {
        const { incomeSources, categoryTotals, totalIncome, totalExpenses, surplus } = model;
        sankeyChartContainer.innerHTML = '';
        const width = Math.max(760, sankeyChartContainer.clientWidth || 0);
        const height = 420;

        const nodes = [{ name: 'Available Income', kind: 'pool' }];
        const links = [];

        incomeSources.forEach(source => {
            const sourceIndex = nodes.push({ name: source.name, kind: 'income' }) - 1;
            links.push({ source: sourceIndex, target: 0, value: source.value });
        });

        if (totalExpenses > totalIncome) {
            const deficitNode = nodes.push({ name: 'Debt / Credit', kind: 'debt' }) - 1;
            links.push({ source: deficitNode, target: 0, value: totalExpenses - totalIncome });
        }

        Object.entries(categoryTotals).forEach(([category, monthlyAmount]) => {
            const annualAmount = monthlyAmount * 12;
            if (annualAmount <= 0) return;
            const kind = category === 'Savings' ? 'savings' : 'expense';
            const categoryNode = nodes.push({ name: category, kind }) - 1;
            links.push({ source: 0, target: categoryNode, value: annualAmount });
        });

        if (surplus > 0) {
            const surplusNode = nodes.push({ name: 'Unallocated Surplus', kind: 'surplus' }) - 1;
            links.push({ source: 0, target: surplusNode, value: surplus });
        }

        const graph = d3.sankey()
            .nodeWidth(18)
            .nodePadding(18)
            .extent([[14, 20], [width - 14, height - 20]])({
                nodes: nodes.map(node => ({ ...node })),
                links: links.map(link => ({ ...link }))
            });

        const nodeColors = {
            income: '#4caf50',
            pool: '#81c784',
            expense: '#ef5350',
            savings: '#26a69a',
            surplus: '#42a5f5',
            debt: '#ffb300'
        };

        const tooltip = getChartTooltip();
        const svg = d3.select('#sankeyChart')
            .append('svg')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('width', '100%')
            .attr('height', height);

        svg.append('g')
            .attr('fill', 'none')
            .selectAll('path')
            .data(graph.links)
            .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', link => {
                const sourceKind = link.source.kind;
                const targetKind = link.target.kind;
                const color = sourceKind === 'income' ? nodeColors.income : nodeColors[targetKind] || '#777';
                return color;
            })
            .attr('stroke-opacity', 0.46)
            .attr('stroke-width', link => Math.max(1, link.width))
            .on('mousemove', (event, link) => {
                tooltip.style('opacity', 1)
                    .html(`<strong>${link.source.name} -> ${link.target.name}</strong><br>$${Math.round(link.value).toLocaleString()} / year`)
                    .style('left', `${event.pageX + 14}px`)
                    .style('top', `${event.pageY - 10}px`);
            })
            .on('mouseleave', () => {
                tooltip.style('opacity', 0);
            });

        const nodeGroup = svg.append('g')
            .selectAll('g')
            .data(graph.nodes)
            .join('g');

        nodeGroup.append('rect')
            .attr('x', node => node.x0)
            .attr('y', node => node.y0)
            .attr('height', node => Math.max(4, node.y1 - node.y0))
            .attr('width', node => node.x1 - node.x0)
            .attr('fill', node => nodeColors[node.kind] || '#7a7a7a')
            .attr('rx', 3)
            .attr('ry', 3)
            .on('mousemove', (event, node) => {
                const nodeValue = Math.max(
                    d3.sum(node.sourceLinks, link => link.value),
                    d3.sum(node.targetLinks, link => link.value)
                );
                tooltip.style('opacity', 1)
                    .html(`<strong>${node.name}</strong><br>$${Math.round(nodeValue).toLocaleString()} / year`)
                    .style('left', `${event.pageX + 14}px`)
                    .style('top', `${event.pageY - 10}px`);
            })
            .on('mouseleave', () => {
                tooltip.style('opacity', 0);
            });

        nodeGroup.append('text')
            .attr('x', node => node.x0 < width / 2 ? node.x1 + 8 : node.x0 - 8)
            .attr('y', node => (node.y0 + node.y1) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', node => node.x0 < width / 2 ? 'start' : 'end')
            .style('font-size', '12px')
            .style('fill', '#ddd')
            .text(node => node.name);
    }

    function renderActionChecklist(model) {
        const container = document.getElementById('actionChecklist');
        if (!model) {
            container.innerHTML = '';
            [
                { status: 'progress', title: 'Complete Bank Setup', detail: 'Add income and key spending categories to unlock insights.' },
                { status: 'next', title: 'Enable Money Flow View', detail: 'The Sankey chart appears automatically once data exists.' },
                { status: 'next', title: 'Create a Monthly Surplus', detail: 'Target positive cash flow by trimming high-impact categories.' }
            ].forEach(item => container.appendChild(buildChecklistItem(item)));
            return;
        }

        const housingRatio = model.totalIncome > 0 ? ((model.categoryTotals['Housing'] || 0) * 12) / model.totalIncome : 0;
        const foodLifestyle = ((model.categoryTotals['Food & Dining'] || 0) + (model.categoryTotals['Entertainment & Lifestyle'] || 0)) * 12;
        const lifestyleRatio = model.totalIncome > 0 ? foodLifestyle / model.totalIncome : 0;
        const emergencyFund = toAmount(window.sankeyData['Emergency Fund']);
        const retirement = toAmount(window.sankeyData['Retirement Savings']);
        const debtMonthly = toAmount(window.sankeyData['Credit Cards']) + toAmount(window.sankeyData['Personal Loans']) + toAmount(window.sankeyData['Student Loans']) + toAmount(window.sankeyData['Medical Debt']);

        const actions = [
            {
                status: model.answeredCount >= 20 ? 'done' : 'progress',
                title: 'Complete profile quality',
                detail: `${model.answeredCount} answers captured. Reach 20+ fields for stronger recommendations.`
            },
            {
                status: model.totalIncome > 0 ? 'done' : 'progress',
                title: 'Income visibility',
                detail: model.totalIncome > 0 ? 'Income data is complete and flowing into your dashboard.' : 'Add monthly income to unlock accurate budgeting.'
            },
            {
                status: housingRatio <= 0.35 ? 'done' : 'progress',
                title: 'Housing affordability',
                detail: `Housing is ${(housingRatio * 100).toFixed(1)}% of income. Keep it near 35% or below.`
            },
            {
                status: emergencyFund > 0 ? 'done' : 'progress',
                title: 'Emergency buffer',
                detail: emergencyFund > 0 ? `You save $${Math.round(emergencyFund).toLocaleString()} monthly toward emergency cash.` : 'Start with a small emergency fund contribution this month.'
            },
            {
                status: retirement > 0 ? 'done' : 'progress',
                title: 'Retirement contribution',
                detail: retirement > 0 ? `You contribute $${Math.round(retirement).toLocaleString()} monthly to retirement.` : 'Add a monthly retirement contribution.'
            },
            {
                status: debtMonthly > 0 && model.surplus > 0 ? 'progress' : 'next',
                title: 'Debt payoff plan',
                detail: debtMonthly > 0 ? `Debt payments are $${Math.round(debtMonthly).toLocaleString()} per month. Use surplus to accelerate payoff.` : 'No major debt payments detected.'
            },
            {
                status: lifestyleRatio <= 0.25 ? 'done' : 'progress',
                title: 'Lifestyle spend control',
                detail: `Food + lifestyle spending is ${(lifestyleRatio * 100).toFixed(1)}% of income.`
            },
            {
                status: model.surplus > 0 ? 'done' : 'progress',
                title: 'Monthly surplus target',
                detail: model.surplus > 0 ? `You are currently positive by $${Math.round(model.surplus).toLocaleString()} per year.` : 'Reduce expenses or increase income to move into surplus.'
            }
        ];

        container.innerHTML = '';
        actions.forEach(item => container.appendChild(buildChecklistItem(item)));
    }

    function renderProductRoadmap() {
        const roadmap = [
            { status: 'done', title: 'Sankey Money Flow', detail: 'Annual income and expenses now render in a stable Sankey view.' },
            { status: 'done', title: 'Action Checklist', detail: 'Dashboard now turns financial data into concrete next steps.' },
            { status: 'done', title: 'Questionnaire Refactor', detail: 'Bank setup now supports quick mode and a cleaner question flow.' },
            { status: 'progress', title: 'Category Budgets', detail: 'Add target caps by category with over/under tracking.' },
            { status: 'progress', title: 'Goal Buckets', detail: 'Support sinking funds for vacations, gifts, and big purchases.' },
            { status: 'next', title: 'Bill Calendar', detail: 'Track recurring due dates and reminders.' },
            { status: 'next', title: 'Transaction Sync', detail: 'Import real bank transactions with auto-categorization.' },
            { status: 'next', title: 'Alert Engine', detail: 'Detect unusual spend spikes and cash flow risk early.' },
            { status: 'next', title: 'Shared Budgets', detail: 'Household collaboration with roles and shared goals.' },
            { status: 'next', title: 'Exports & Reports', detail: 'CSV/PDF exports for monthly reviews and tax prep.' }
        ];

        const container = document.getElementById('productRoadmap');
        container.innerHTML = '';
        roadmap.forEach(item => container.appendChild(buildChecklistItem(item)));
    }

    function buildChecklistItem(item) {
        const li = document.createElement('li');
        li.className = 'checklist-item';
        const statusMap = {
            done: { label: 'Live', className: 'status-done' },
            progress: { label: 'In Progress', className: 'status-progress' },
            next: { label: 'Next', className: 'status-next' }
        };
        const status = statusMap[item.status] || statusMap.next;
        li.innerHTML = `
            <span class="status-pill ${status.className}">${status.label}</span>
            <div>
                <strong>${item.title}</strong>
                <span>${item.detail}</span>
            </div>
        `;
        return li;
    }
    
    function createDonutChart(containerId, legendId, data, total, title, colorScheme) {
        const container = document.getElementById(containerId);
        const legendContainer = document.getElementById(legendId);
        
        // Clear previous content
        container.innerHTML = '';
        legendContainer.innerHTML = '';
        
        if (data.length === 0 || total === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
            return;
        }
        
        const width = container.clientWidth || 300;
        const height = 350;
        const radius = Math.min(width, height) / 2 - 20;
        
        const svg = d3.select(`#${containerId}`)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
        
        // Color scale
        const colors = d3.scaleOrdinal()
            .domain(data.map(d => d.name))
            .range(d3.schemeCategory10);
        
        // Create pie generator
        const pie = d3.pie()
            .value(d => d.value)
            .sort(null)
            .padAngle(0.02);
        
        // Create arc generator
        const arc = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius);
        
        const arcHover = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius + 10);
        
        // Reuse a single shared tooltip
        const tooltip = getChartTooltip();
        
        // Draw arcs
        const arcs = svg.selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("fill", d => colors(d.data.name))
            .attr("d", arc)
            .style("cursor", "pointer")
            .style("stroke", "#222")
            .style("stroke-width", "2px")
            .style("opacity", 0)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arcHover)
                    .style("opacity", 1)
                    .style("stroke", "#fff")
                    .style("stroke-width", "3px");
                
                const percentage = ((d.data.value / total) * 100).toFixed(1);
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 1);
                tooltip.html(`
                    <strong>${d.data.name}</strong><br/>
                    <span style="color: #4caf50;">$${d.data.value.toLocaleString()}</span><br/>
                    <span style="color: #999; font-size: 12px;">${percentage}% of total ${title.toLowerCase()}</span>
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arc)
                    .style("opacity", 0.9)
                    .style("stroke", "#222")
                    .style("stroke-width", "2px");
                
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0);
            });
        
        // Animate arcs
        arcs.transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .style("opacity", 0.9)
            .attrTween("d", function(d) {
                const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
                return function(t) {
                    return arc(interpolate(t));
                };
            });
        
        // Center label
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "-8")
            .style("font-size", "16px")
            .style("font-weight", "600")
            .style("fill", colorScheme)
            .text(`Total ${title}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(600)
            .style("opacity", 1);
        
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "12")
            .style("font-size", "22px")
            .style("font-weight", "bold")
            .style("fill", "#fff")
            .text(`$${total.toLocaleString()}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(700)
            .style("opacity", 1);
        
        // Create legend
        data.forEach((item, i) => {
            const percentage = ((item.value / total) * 100).toFixed(1);
            const legendItem = document.createElement('div');
            legendItem.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 5px; background: #333;';
            legendItem.innerHTML = `
                <div style="width: 16px; height: 16px; background: ${colors(item.name)}; border-radius: 3px; flex-shrink: 0;"></div>
                <div style="flex: 1; color: #ccc; font-size: 13px;">${item.name}</div>
                <div style="color: #fff; font-weight: bold; font-size: 13px;">$${item.value.toLocaleString()}</div>
                <div style="color: #999; font-size: 12px; min-width: 45px; text-align: right;">${percentage}%</div>
            `;
            legendContainer.appendChild(legendItem);
        });
    }
</script>
</body>
</html> 
