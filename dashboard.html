<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" />
    <title>Dashboard - BonoBudget</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
         crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-radius: 0 0 20px 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .nav {
            display: flex;
            gap: 30px;
        }
        
        .nav-item {
            color: #ccc;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #333;
            color: #fff;
        }
        
        .nav-item.active {
            background: #4caf50;
            color: #fff;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-email {
            color: #ccc;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: #ff5252;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        
        .welcome-text {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        /* Google Ads Styling */
        .ads-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }
        
        .ad-sidebar {
            width: 300px;
            min-height: 600px;
            background: #222;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .ad-banner {
            width: 100%;
            height: 90px;
            background: #333;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ccc;
        }
        
        .main-content {
            flex: 1;
            background: #222;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .ad-sidebar {
                width: 100%;
                min-height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">Bonobudget</div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="welcome-text" id="welcome"></div>
        
        <div class="content-wrapper">
            <!-- Left Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></script>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <h2 style="color:#4caf50;text-align:center;margin-top:40px;">Your Financial Overview</h2>
                
                <!-- Summary Cards -->
                <div id="summaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <!-- Time Period Display -->
                <div id="timePeriod" style="text-align: center; color: #999; margin-bottom: 20px; font-size: 14px;">
                    Annual Overview
                </div>
                
                <!-- Charts Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <!-- Income Chart -->
                    <div style="background: #2a2a2a; border-radius: 15px; padding: 25px;">
                        <h3 style="color: #4caf50; text-align: center; margin-bottom: 20px; font-size: 20px;">Income Sources</h3>
                        <div id="incomeChart" style="width: 100%; height: 350px;"></div>
                        <div id="incomeLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                    
                    <!-- Expenses Chart -->
                    <div style="background: #2a2a2a; border-radius: 15px; padding: 25px;">
                        <h3 style="color: #ff5252; text-align: center; margin-bottom: 20px; font-size: 20px;">Expense Categories</h3>
                        <div id="expenseChart" style="width: 100%; height: 350px;"></div>
                        <div id="expenseLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsgoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        </div>
        
        <!-- Bottom Banner Ad -->
        <div style="margin-top: 30px; text-align: center;">
            <div class="ad-banner" style="height: 120px; margin: 0 auto; max-width: 728px;">
                <!-- Google AdSense - Bottom Banner -->
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                     crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2901233728197269"
                     data-ad-slot="YOUR_AD_SLOT_ID"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #incomeChart, #expenseChart {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .chart-tooltip {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        @media (max-width: 1200px) {
            .main-content > div:last-child {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function loadSankeyData(uid) {
        db.collection('users').doc(uid).collection('spending').doc('categories').get().then(doc => {
            if (!doc.exists) {
                console.log('No spending data found');
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
                return;
            }
            const data = doc.data();
            console.log('Loaded data:', data);
            
            // Store data globally for access in click handlers
            window.sankeyData = data;
            
            // Calculate income sources
            const incomeSources = [];
            const primaryIncome = parseFloat(data['Primary Monthly Income']) || 0;
            const additionalIncome = parseFloat(data['Additional Monthly Income']) || 0;
            
            if (primaryIncome > 0) {
                incomeSources.push({
                    name: data['Primary Income Source'] || 'Primary Income',
                    amount: primaryIncome * 12
                });
            }
            
            if (additionalIncome > 0) {
                incomeSources.push({
                    name: 'Additional Income',
                    amount: additionalIncome * 12
                });
            }
            
            const irregularIncome = parseFloat(data['Annual Irregular Income']) || 0;
            if (irregularIncome > 0) {
                incomeSources.push({
                    name: 'Irregular Income',
                    amount: irregularIncome
                });
            }
            
            // If no income sources found, use total income
            if (incomeSources.length === 0) {
                const totalMonthlyIncome = parseFloat(data['Total Monthly Income']) || 0;
                if (totalMonthlyIncome > 0) {
                    incomeSources.push({
                        name: 'Total Income',
                        amount: totalMonthlyIncome * 12
                    });
                }
            }
            
            // Calculate category totals and subcategory totals
            const categoryTotals = {};
            const subcategoryTotals = {};
            
            // Define savings items
            const savingsItems = ['Emergency Fund', 'Retirement Savings', 'Investment Accounts', 'College Savings'];
            
            for (const category of spendingCategories) {
                if (category.title === 'Income') continue;
                
                let categoryTotal = 0;
                let savingsTotal = 0;
                
                for (const item of category.items) {
                    const value = data[item.label];
                    // Skip Mortgage Principal as it's handled separately
                    if (item.label === 'Mortgage Principal') continue;
                    
                    if (value && value !== 'skipped' && !isNaN(parseFloat(value))) {
                        const numValue = parseFloat(value);
                        
                        // Check if this is a savings item
                        if (savingsItems.includes(item.label)) {
                            savingsTotal += numValue;
                            subcategoryTotals[item.label] = numValue;
                        } else {
                            categoryTotal += numValue;
                            subcategoryTotals[item.label] = numValue;
                        }
                    }
                }
                
                // Handle special case for mortgage principal
                if (category.title === 'Housing') {
                    const mortgagePrincipal = parseFloat(data['Mortgage Principal']) || 0;
                    if (mortgagePrincipal > 0) {
                        categoryTotal += mortgagePrincipal;
                        subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                    }
                }
                
                if (categoryTotal > 0) {
                    categoryTotals[category.title] = categoryTotal;
                }
            }
            
            // Add savings as a separate category
            const totalSavings = savingsItems.reduce((total, item) => {
                return total + (parseFloat(data[item]) || 0);
            }, 0);
            
            if (totalSavings > 0) {
                categoryTotals['Savings'] = totalSavings;
            }
            
            console.log('Income sources:', incomeSources);
            console.log('Category totals:', categoryTotals);
            console.log('Subcategory totals:', subcategoryTotals);
            
            if (incomeSources.length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No income data found. Please complete the income section of the bank questionnaire.</div>';
                return;
            }
            
            if (Object.keys(categoryTotals).length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data found. Please complete the spending section of the bank questionnaire.</div>';
                return;
            }
            
            createSunburstChart(incomeSources, categoryTotals, subcategoryTotals);
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error loading data. Please try again.</div>';
        });
    }

    function createSunburstChart(incomeSources, categoryTotals, subcategoryTotals) {
        // Calculate totals
        const totalIncome = incomeSources.reduce((sum, source) => sum + source.amount, 0);
        const totalExpenses = Object.values(categoryTotals).reduce((sum, val) => sum + (val * 12), 0);
        const surplus = totalIncome - totalExpenses;
        
        if (totalIncome === 0) {
            document.getElementById('summaryCards').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px; grid-column: 1 / -1;">No income data found. Please complete the income section of the bank questionnaire.</div>';
            return;
        }
        
        // Create summary cards
        const summaryCards = document.getElementById('summaryCards');
        summaryCards.innerHTML = `
            <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Income</div>
                <div style="font-size: 32px; font-weight: bold;">$${totalIncome.toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, #ff5252 0%, #e53935 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Expenses</div>
                <div style="font-size: 32px; font-weight: bold;">$${totalExpenses.toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, ${surplus >= 0 ? '#4caf50' : '#ff5252'} 0%, ${surplus >= 0 ? '#45a049' : '#e53935'} 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">${surplus >= 0 ? 'Surplus' : 'Deficit'}</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.abs(surplus).toLocaleString()}</div>
                ${surplus < 0 ? '<div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">You are spending more than you earn</div>' : ''}
            </div>
        `;
        
        // Create income donut chart
        createDonutChart('incomeChart', 'incomeLegend', incomeSources, totalIncome, 'Income', '#4caf50');
        
        // Create expenses donut chart
        const expenseData = Object.keys(categoryTotals).map(category => ({
            name: category,
            value: categoryTotals[category] * 12
        }));
        createDonutChart('expenseChart', 'expenseLegend', expenseData, totalExpenses, 'Expenses', '#ff5252');
    }
    
    function createDonutChart(containerId, legendId, data, total, title, colorScheme) {
        const container = document.getElementById(containerId);
        const legendContainer = document.getElementById(legendId);
        
        // Clear previous content
        container.innerHTML = '';
        legendContainer.innerHTML = '';
        
        if (data.length === 0 || total === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
            return;
        }
        
        const width = container.clientWidth || 300;
        const height = 350;
        const radius = Math.min(width, height) / 2 - 20;
        
        const svg = d3.select(`#${containerId}`)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
        
        // Color scale
        const colors = d3.scaleOrdinal()
            .domain(data.map(d => d.name))
            .range(d3.schemeCategory10);
        
        // Create pie generator
        const pie = d3.pie()
            .value(d => d.value)
            .sort(null)
            .padAngle(0.02);
        
        // Create arc generator
        const arc = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius);
        
        const arcHover = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius + 10);
        
        // Create tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "chart-tooltip")
            .style("opacity", 0)
            .style("position", "absolute")
            .style("background", "rgba(0, 0, 0, 0.9)")
            .style("color", "#fff")
            .style("padding", "12px")
            .style("border-radius", "8px")
            .style("pointer-events", "none")
            .style("font-size", "14px")
            .style("z-index", "10000")
            .style("box-shadow", "0 4px 12px rgba(0,0,0,0.3)");
        
        // Draw arcs
        const arcs = svg.selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("fill", d => colors(d.data.name))
            .attr("d", arc)
            .style("cursor", "pointer")
            .style("stroke", "#222")
            .style("stroke-width", "2px")
            .style("opacity", 0)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arcHover)
                    .style("opacity", 1)
                    .style("stroke", "#fff")
                    .style("stroke-width", "3px");
                
                const percentage = ((d.data.value / total) * 100).toFixed(1);
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 1);
                tooltip.html(`
                    <strong>${d.data.name}</strong><br/>
                    <span style="color: #4caf50;">$${d.data.value.toLocaleString()}</span><br/>
                    <span style="color: #999; font-size: 12px;">${percentage}% of total ${title.toLowerCase()}</span>
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arc)
                    .style("opacity", 0.9)
                    .style("stroke", "#222")
                    .style("stroke-width", "2px");
                
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0);
            });
        
        // Animate arcs
        arcs.transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .style("opacity", 0.9)
            .attrTween("d", function(d) {
                const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
                return function(t) {
                    return arc(interpolate(t));
                };
            });
        
        // Center label
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "-8")
            .style("font-size", "16px")
            .style("font-weight", "600")
            .style("fill", colorScheme)
            .text(`Total ${title}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(600)
            .style("opacity", 1);
        
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "12")
            .style("font-size", "22px")
            .style("font-weight", "bold")
            .style("fill", "#fff")
            .text(`$${total.toLocaleString()}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(700)
            .style("opacity", 1);
        
        // Create legend
        data.forEach((item, i) => {
            const percentage = ((item.value / total) * 100).toFixed(1);
            const legendItem = document.createElement('div');
            legendItem.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 5px; background: #333;';
            legendItem.innerHTML = `
                <div style="width: 16px; height: 16px; background: ${colors(item.name)}; border-radius: 3px; flex-shrink: 0;"></div>
                <div style="flex: 1; color: #ccc; font-size: 13px;">${item.name}</div>
                <div style="color: #fff; font-weight: bold; font-size: 13px;">$${item.value.toLocaleString()}</div>
                <div style="color: #999; font-size: 12px; min-width: 45px; text-align: right;">${percentage}%</div>
            `;
            legendContainer.appendChild(legendItem);
        });
    }
</script>
</body>
</html> 