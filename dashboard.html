<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" />
    <title>Dashboard - BonoBudget</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
         crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-radius: 0 0 20px 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .nav {
            display: flex;
            gap: 30px;
        }
        
        .nav-item {
            color: #ccc;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #333;
            color: #fff;
        }
        
        .nav-item.active {
            background: #4caf50;
            color: #fff;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-email {
            color: #ccc;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: #ff5252;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        
        .welcome-text {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        /* Google Ads Styling */
        .ads-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }
        
        .ad-sidebar {
            width: 300px;
            min-height: 600px;
            background: #222;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .ad-banner {
            width: 100%;
            height: 90px;
            background: #333;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ccc;
        }
        
        .main-content {
            flex: 1;
            background: #222;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .ad-sidebar {
                width: 100%;
                min-height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">Bonobudget</div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="welcome-text" id="welcome"></div>
        
        <div class="content-wrapper">
            <!-- Left Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></script>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <h2 style="color:#4caf50;text-align:center;margin-top:40px;">Your Financial Flow</h2>
                <div id="sankey_chart" style="width:100%;height:600px;margin:0 auto;background:#333;border-radius:20px;padding:20px;"></div>
            </div>
            
            <!-- Right Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsgoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        </div>
        
        <!-- Bottom Banner Ad -->
        <div style="margin-top: 30px; text-align: center;">
            <div class="ad-banner" style="height: 120px; margin: 0 auto; max-width: 728px;">
                <!-- Google AdSense - Bottom Banner -->
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                     crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2901233728197269"
                     data-ad-slot="YOUR_AD_SLOT_ID"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>
    <!-- D3.js and D3 Sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        .node rect {
            stroke: #333;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            will-change: transform, filter;
        }
        .node rect:hover {
            stroke: #4caf50;
            stroke-width: 2px;
            transform: scale(1.05);
            filter: drop-shadow(0 4px 8px rgba(76, 175, 80, 0.3));
        }
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-family: 'Montserrat', Arial, sans-serif;
            fill: #fff;
            transition: all 0.3s ease;
        }
        .node:hover text {
            fill: #4caf50;
            font-weight: 600;
        }
        .link {
            fill: none;
            stroke-opacity: 0.8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            stroke-dasharray: 0;
            will-change: stroke-opacity, stroke-width, filter;
            stroke-linecap: round;
        }
        .link:hover {
            stroke-opacity: 0.9;
            stroke-width: 3px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        .link.flowing {
            stroke-dasharray: 5, 5;
            animation: flow 2s linear infinite;
        }
        @keyframes flow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 10; }
        }
        .node.entering {
            opacity: 0;
            transform: scale(0.8);
        }
        .node.entered {
            opacity: 1;
            transform: scale(1);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .link.entering {
            opacity: 0;
            stroke-dasharray: 0, 1000;
        }
        .link.entered {
            opacity: 1;
            stroke-dasharray: 0;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node.pulsing {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .value-counter {
            font-weight: bold;
            transition: all 0.5s ease;
        }
        .value-counter.animating {
            animation: countUp 1s ease-out;
        }
        @keyframes countUp {
            0% { transform: scale(0.8); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    auth.onAuthStateChanged(function(user) {
        if (user) {
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });
    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function loadSankeyData(uid) {
        db.collection('users').doc(uid).collection('spending').doc('categories').get().then(doc => {
            if (!doc.exists) {
                console.log('No spending data found');
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data available. Please complete the bank questionnaire first.</div>';
                return;
            }
            const data = doc.data();
            console.log('Loaded data:', data);
            
            // Store data globally for access in click handlers
            window.sankeyData = data;
            
            // Calculate income sources
            const incomeSources = [];
            const primaryIncome = parseFloat(data['Primary Monthly Income']) || 0;
            const additionalIncome = parseFloat(data['Additional Monthly Income']) || 0;
            
            if (primaryIncome > 0) {
                incomeSources.push({
                    name: data['Primary Income Source'] || 'Primary Income',
                    amount: primaryIncome * 12
                });
            }
            
            if (additionalIncome > 0) {
                incomeSources.push({
                    name: 'Additional Income',
                    amount: additionalIncome * 12
                });
            }
            
            const irregularIncome = parseFloat(data['Annual Irregular Income']) || 0;
            if (irregularIncome > 0) {
                incomeSources.push({
                    name: 'Irregular Income',
                    amount: irregularIncome
                });
            }
            
            // If no income sources found, use total income
            if (incomeSources.length === 0) {
                const totalMonthlyIncome = parseFloat(data['Total Monthly Income']) || 0;
                if (totalMonthlyIncome > 0) {
                    incomeSources.push({
                        name: 'Total Income',
                        amount: totalMonthlyIncome * 12
                    });
                }
            }
            
            // Calculate category totals and subcategory totals
            const categoryTotals = {};
            const subcategoryTotals = {};
            
            // Define savings items
            const savingsItems = ['Emergency Fund', 'Retirement Savings', 'Investment Accounts', 'College Savings'];
            
            for (const category of spendingCategories) {
                if (category.title === 'Income') continue;
                
                let categoryTotal = 0;
                let savingsTotal = 0;
                
                for (const item of category.items) {
                    const value = data[item.label];
                    // Skip Mortgage Principal as it's handled separately
                    if (item.label === 'Mortgage Principal') continue;
                    
                    if (value && value !== 'skipped' && !isNaN(parseFloat(value))) {
                        const numValue = parseFloat(value);
                        
                        // Check if this is a savings item
                        if (savingsItems.includes(item.label)) {
                            savingsTotal += numValue;
                            subcategoryTotals[item.label] = numValue;
                        } else {
                            categoryTotal += numValue;
                            subcategoryTotals[item.label] = numValue;
                        }
                    }
                }
                
                // Handle special case for mortgage principal
                if (category.title === 'Housing') {
                    const mortgagePrincipal = parseFloat(data['Mortgage Principal']) || 0;
                    if (mortgagePrincipal > 0) {
                        categoryTotal += mortgagePrincipal;
                        subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                    }
                }
                
                if (categoryTotal > 0) {
                    categoryTotals[category.title] = categoryTotal;
                }
            }
            
            // Add savings as a separate category
            const totalSavings = savingsItems.reduce((total, item) => {
                return total + (parseFloat(data[item]) || 0);
            }, 0);
            
            if (totalSavings > 0) {
                categoryTotals['Savings'] = totalSavings;
            }
            
            console.log('Income sources:', incomeSources);
            console.log('Category totals:', categoryTotals);
            console.log('Subcategory totals:', subcategoryTotals);
            
            if (incomeSources.length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No income data found. Please complete the income section of the bank questionnaire.</div>';
                return;
            }
            
            if (Object.keys(categoryTotals).length === 0) {
                document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No spending data found. Please complete the spending section of the bank questionnaire.</div>';
                return;
            }
            
            createSankeyChart(incomeSources, categoryTotals, subcategoryTotals);
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('sankey_chart').innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error loading data. Please try again.</div>';
        });
    }

    function createSankeyChart(incomeSources, categoryTotals, subcategoryTotals) {
        const chartContainer = document.getElementById('sankey_chart');
        
        // Clear previous chart
        chartContainer.innerHTML = '';
        
        // Prepare data for D3 Sankey
        const nodes = [];
        const links = [];
        const nodeNames = new Set(); // Track all node names
        
        // Add income source nodes
        incomeSources.forEach(source => {
            nodes.push({ 
                name: source.name,
                value: source.amount
            });
            nodeNames.add(source.name);
        });
        
        // Add budget node
        const totalIncome = incomeSources.reduce((sum, source) => sum + source.amount, 0);
        nodes.push({ 
            name: "Budget",
            value: totalIncome
        });
        nodeNames.add("Budget");
        
        // Add category nodes (only main categories, no subcategories)
        Object.keys(categoryTotals).forEach(category => {
            nodes.push({ 
                name: category,
                value: categoryTotals[category] * 12
            });
            nodeNames.add(category);
        });
        
        // Create a mapping from node names to indices
        const nodeNameToIndex = {};
        nodes.forEach((node, index) => {
            nodeNameToIndex[node.name] = index;
        });
        
        // Create links from income sources to budget
        const totalIncome = incomeSources.reduce((sum, source) => sum + source.amount, 0);
        incomeSources.forEach(source => {
            if (nodeNames.has(source.name) && nodeNames.has("Budget")) {
                const link = {
                    source: nodes[nodeNameToIndex[source.name]],
                    target: nodes[nodeNameToIndex["Budget"]],
                    value: source.amount
                };
                links.push(link);
                console.log('Added income link:', source.name, '-> Budget, value:', source.amount);
            }
        });
        
        // Create links from budget to categories
        Object.keys(categoryTotals).forEach(category => {
            if (nodeNames.has("Budget") && nodeNames.has(category)) {
                const link = {
                    source: nodes[nodeNameToIndex["Budget"]],
                    target: nodes[nodeNameToIndex[category]],
                    value: categoryTotals[category] * 12
                };
                links.push(link);
                console.log('Added category link: Budget ->', category, 'value:', categoryTotals[category] * 12);
            }
        });
        
        console.log('Sankey nodes:', nodes.map(n => n.name));
        console.log('Sankey links:', links.map(l => `${l.source.name} → ${l.target.name}`));
        
        // Validate that all links reference existing nodes
        const validLinks = links.filter(link => {
            const sourceExists = link.source && nodes.includes(link.source);
            const targetExists = link.target && nodes.includes(link.target);
            if (!sourceExists || !targetExists) {
                console.warn(`Removing invalid link: ${link.source?.name || 'unknown'} → ${link.target?.name || 'unknown'}`);
                return false;
            }
            return true;
        });
        
        console.log('Valid links count:', validLinks.length);
        
        if (validLinks.length === 0) {
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">No valid data connections found. Please complete the bank questionnaire with both income and spending data.</div>';
            return;
        }
        
        // Create the chart
        const width = chartContainer.clientWidth - 40; // Account for padding
        const height = chartContainer.clientHeight - 40; // Use container height instead of fixed height
        
        const svg = d3.select("#sankey_chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(40)
            .extent([[1, 1], [width - 1, height - 1]]);
        
        console.log('Sankey extent:', [1, 1], [width - 1, height - 1]);
        console.log('Chart dimensions:', width, 'x', height);
        
        try {
            console.log('About to create Sankey with nodes:', nodes.length, 'and links:', validLinks.length);
            console.log('Nodes:', nodes);
            console.log('Valid links:', validLinks);
            
            const {nodes: sankeyNodes, links: sankeyLinks} = sankey({
                nodes: nodes,
                links: validLinks
            });
            
            console.log('Sankey nodes after layout:', sankeyNodes.map(n => ({
                name: n.name,
                x0: n.x0,
                x1: n.x1,
                y0: n.y0,
                y1: n.y1
            })));
            console.log('Sankey links after layout:', sankeyLinks.map(l => ({
                source: l.source.name,
                target: l.target.name,
                value: l.value,
                width: l.width
            })));
            
            const color = d3.scaleOrdinal()
                .domain(nodes.map(d => d.name))
                .range(d3.schemeCategory10);
            
            // Create links with staggered animation
            const linkGroup = svg.append("g")
                .selectAll("path")
                .data(sankeyLinks)
                .join("path")
                    .attr("class", "link entering")
                    .attr("d", d => {
                        // Use Sankey link generator
                        const path = d3.sankeyLinkHorizontal()(d);
                        console.log('Link path for', d.source.name, '->', d.target.name, ':', path);
                        return path;
                    })
                    .attr("stroke", d => {
                        console.log('Link stroke color for', d.source.name, '->', d.target.name, ':', color(d.source.name));
                        return color(d.source.name);
                    })
                    .attr("stroke-width", d => {
                        const width = Math.max(3, d.width || 3);
                        console.log('Link width for', d.source.name, '->', d.target.name, ':', width);
                        return width;
                    })
                    .attr("fill", "none")
                    .on("click", function(event, d) {
                        // Toggle detailed breakdown for this link
                        toggleDetailedBreakdown(d, event, window.sankeyData);
                    })
                    .append("title")
                    .text(d => `${d.source.name} → ${d.target.name}\n$${d.value.toLocaleString()}`);
            
            console.log('Created', linkGroup.size(), 'links');
            
            // Debug: Add a simple test line to see if rendering works
            svg.append("line")
                .attr("x1", 50)
                .attr("y1", 50)
                .attr("x2", 200)
                .attr("y2", 100)
                .attr("stroke", "red")
                .attr("stroke-width", 3)
                .attr("opacity", 0.5);

            // Animate links with stagger
            linkGroup.each(function(d, i) {
                const linkElement = d3.select(this);
                
                // Debug: log the link path
                console.log('Link', i, ':', d.source.name, '->', d.target.name, 'path:', linkElement.attr('d'));
                
                linkElement
                    .transition()
                    .delay(i * 100)
                    .duration(800)
                    .attr("class", "link entered")
                    .on("end", function() {
                        // Add flowing animation to important links
                        if (d.source.name === "Budget" || d.target.name === "Budget") {
                            d3.select(this).classed("flowing", true);
                        }
                    });
            });
            
            // Add periodic flowing animation to all links
            setInterval(() => {
                svg.selectAll(".link.entered")
                    .classed("flowing", false)
                    .transition()
                    .delay(1000)
                    .duration(0)
                    .each(function() {
                        if (Math.random() > 0.8) {
                            d3.select(this).classed("flowing", true);
                        }
                    });
            }, 5000);
            
            // Create nodes with staggered animation
            const node = svg.append("g")
                .selectAll("g")
                .data(sankeyNodes)
                .join("g")
                    .attr("class", "node entering");
            
            node.append("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", d => color(d.name));

            // Animate nodes with stagger
            node.each(function(d, i) {
                d3.select(this)
                    .transition()
                    .delay(i * 150 + 200) // Start after links begin
                    .duration(600)
                    .attr("class", "node entered")
                    .on("end", function() {
                        // Add subtle pulse to important nodes
                        if (d.name === "Budget" || d.name.includes("Income")) {
                            d3.select(this).classed("pulsing", true);
                        }
                    });
            });
            
            // Add node labels
            node.append("text")
                .attr("x", d => d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2 - 8)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .text(d => d.name)
                .filter(d => d.x0 < width / 2)
                .attr("x", d => d.x1 + 6)
                .attr("text-anchor", "start");
            
            // Add amount labels under the node names with animation
            const valueLabels = node.append("text")
                .attr("x", d => d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2 + 8)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .attr("font-size", "10px")
                .attr("fill", "#ccc")
                .attr("class", "value-counter")
                .text("")
                .filter(d => d.x0 < width / 2)
                .attr("x", d => d.x1 + 6)
                .attr("text-anchor", "start");

            // Animate value counters
            valueLabels.each(function(d, i) {
                const element = d3.select(this);
                let totalValue = 0;
                
                // Calculate the total value for this node
                if (incomeSources.some(source => source.name === d.name)) {
                    const source = incomeSources.find(source => source.name === d.name);
                    totalValue = source ? source.amount : 0;
                } else if (categoryTotals[d.name]) {
                    totalValue = categoryTotals[d.name] * 12;
                } else if (d.name === "Budget") {
                    totalValue = incomeSources.reduce((sum, source) => sum + source.amount, 0);
                }
                
                if (totalValue > 0) {
                    // Animate the counter
                    element.transition()
                        .delay(i * 150 + 800) // Start after nodes appear
                        .duration(1000)
                        .tween("text", function() {
                            const interpolator = d3.interpolateNumber(0, totalValue);
                            return function(t) {
                                const currentValue = interpolator(t);
                                element.text(`$${Math.round(currentValue).toLocaleString()}`)
                                    .classed("animating", t < 0.1);
                            };
                        });
                }
            });
            
            // Function to toggle detailed breakdown
            function toggleDetailedBreakdown(linkData, event) {
                const targetCategory = linkData.target.name;
                
                // Only expand for category links (from Budget to categories)
                if (linkData.source.name !== "Budget") return;
                
                // Check if this category is already expanded
                const isExpanded = sankeyNodes.some(node => 
                    node.name !== targetCategory && 
                    spendingCategories.some(cat => cat.title === targetCategory && 
                        cat.items.some(item => item.label === node.name))
                );
                
                if (isExpanded) {
                    // Collapse back to original view
                    hideDetailedBreakdown();
                } else {
                    // Expand to show subcategories
                    showDetailedBreakdown(linkData, event, window.sankeyData);
                }
            }
            
            // Function to show detailed breakdown
            function showDetailedBreakdown(linkData, event, firestoreData) {
                const targetCategory = linkData.target.name;
                
                // Only expand for category links (from Budget to categories)
                if (linkData.source.name !== "Budget") return;
                
                // Find all subcategories for this category
                const subcategories = [];
                for (const category of spendingCategories) {
                    if (category.title === targetCategory) {
                        for (const item of category.items) {
                            const value = parseFloat(firestoreData[item.label]) || 0;
                            if (value > 0 && item.label !== 'Mortgage Principal') {
                                subcategories.push({
                                    name: item.label,
                                    amount: value * 12
                                });
                            }
                        }
                        break;
                    }
                }
                
                // Handle special case for Housing with Mortgage Principal
                if (targetCategory === 'Housing') {
                    const mortgagePrincipal = parseFloat(firestoreData['Mortgage Principal']) || 0;
                    if (mortgagePrincipal > 0) {
                        subcategories.push({
                            name: 'Mortgage Principal',
                            amount: mortgagePrincipal * 12
                        });
                    }
                }
                
                // Handle special case for Savings
                if (targetCategory === 'Savings') {
                    const savingsItems = ['Emergency Fund', 'Retirement Savings', 'Investment Accounts', 'College Savings'];
                    savingsItems.forEach(item => {
                        const value = parseFloat(firestoreData[item]) || 0;
                        if (value > 0) {
                            subcategories.push({
                                name: item,
                                amount: value * 12
                            });
                        }
                    });
                }
                
                if (subcategories.length > 0) {
                    // Create expanded nodes and links for subcategories
                    const expandedNodes = [...sankeyNodes];
                    const expandedLinks = [...sankeyLinks];
                    
                    // Add subcategory nodes
                    subcategories.forEach(sub => {
                        expandedNodes.push({ name: sub.name });
                    });
                    
                    // Add links from the category to its subcategories
                    subcategories.forEach(sub => {
                        expandedLinks.push({
                            source: expandedNodes.find(n => n.name === targetCategory),
                            target: expandedNodes.find(n => n.name === sub.name),
                            value: sub.amount
                        });
                    });
                    
                    // Recalculate Sankey layout with expanded data
                    const expandedSankey = d3.sankey()
                        .nodeWidth(20)
                        .nodePadding(40)
                        .extent([[1, 1], [width - 1, height - 1]]);
                    
                    const {nodes: newNodes, links: newLinks} = expandedSankey({
                        nodes: expandedNodes,
                        links: expandedLinks
                    });
                    
                    // Update the visualization
                    updateSankeyVisualization(newNodes, newLinks, color);
                }
            }
            
            // Function to hide detailed breakdown
            function hideDetailedBreakdown() {
                // Revert to original Sankey layout
                const {nodes: originalNodes, links: originalLinks} = sankey({
                    nodes: nodes,
                    links: validLinks
                });
                
                updateSankeyVisualization(originalNodes, originalLinks, color);
            }
            
            // Function to update the Sankey visualization with smooth transitions
            function updateSankeyVisualization(sankeyNodes, sankeyLinks, colorScale) {
                // Store current positions for smooth transitions
                const currentNodes = svg.selectAll(".node").data();
                const currentLinks = svg.selectAll(".link").data();
                
                // Create position mapping for smooth transitions
                const nodePositions = new Map();
                currentNodes.forEach(d => {
                    nodePositions.set(d.name, { x0: d.x0, x1: d.x1, y0: d.y0, y1: d.y1 });
                });
                
                // Update links with smooth transition
                const linkGroup = svg.selectAll(".link")
                    .data(sankeyLinks, d => `${d.source.name}-${d.target.name}`);
                
                linkGroup.exit()
                    .transition()
                    .duration(400)
                    .style("opacity", 0)
                    .remove();
                
                const linkEnter = linkGroup.enter()
                    .append("path")
                    .attr("class", "link entering")
                    .attr("d", d => {
                        const source = nodePositions.get(d.source.name);
                        const target = nodePositions.get(d.target.name);
                        if (source && target) {
                            return `M${source.x1},${(source.y0 + source.y1) / 2}L${target.x0},${(target.y0 + target.y1) / 2}`;
                        }
                        return d3.sankeyLinkHorizontal()(d);
                    })
                    .attr("stroke", d => colorScale(d.source.name))
                    .attr("stroke-width", d => Math.max(3, d.width || 3))
                    .on("click", function(event, d) {
                        toggleDetailedBreakdown(d, event, window.sankeyData);
                    })
                    .append("title")
                    .text(d => `${d.source.name} → ${d.target.name}\n$${d.value.toLocaleString()}`);
                
                linkGroup.merge(linkEnter)
                    .transition()
                    .duration(600)
                    .attr("class", "link entered")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("stroke", d => colorScale(d.source.name))
                    .attr("stroke-width", d => Math.max(3, d.width || 3));
                
                // Update nodes with smooth transition
                const nodeGroup = svg.selectAll(".node")
                    .data(sankeyNodes, d => d.name);
                
                nodeGroup.exit()
                    .transition()
                    .duration(400)
                    .style("opacity", 0)
                    .style("transform", "scale(0.8)")
                    .remove();
                
                const nodeEnter = nodeGroup.enter()
                    .append("g")
                    .attr("class", "node entering")
                    .style("opacity", 0)
                    .style("transform", "scale(0.8)");
                
                nodeEnter.append("rect")
                    .attr("x", d => d.x0)
                    .attr("y", d => d.y0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("width", d => d.x1 - d.x0)
                    .attr("fill", d => colorScale(d.name));
                
                // Animate all nodes
                nodeGroup.merge(nodeEnter)
                    .transition()
                    .duration(600)
                    .style("opacity", 1)
                    .style("transform", "scale(1)")
                    .attr("class", "node entered");
                
                // Update node positions
                nodeGroup.select("rect")
                    .transition()
                    .duration(600)
                    .attr("x", d => d.x0)
                    .attr("y", d => d.y0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("width", d => d.x1 - d.x0)
                    .attr("fill", d => colorScale(d.name));
                
                // Add node labels with animation
                const nodeLabels = nodeGroup.selectAll("text")
                    .data(d => [d]);
                
                nodeLabels.exit().remove();
                
                const nodeLabelsEnter = nodeLabels.enter()
                    .append("text")
                    .attr("x", d => d.x0 - 6)
                    .attr("y", d => (d.y1 + d.y0) / 2 - 8)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "end")
                    .text(d => d.name)
                    .filter(d => d.x0 < width / 2)
                    .attr("x", d => d.x1 + 6)
                    .attr("text-anchor", "start");
                
                nodeLabels.merge(nodeLabelsEnter)
                    .transition()
                    .duration(600)
                    .attr("x", d => d.x0 - 6)
                    .attr("y", d => (d.y1 + d.y0) / 2 - 8)
                    .filter(d => d.x0 < width / 2)
                    .attr("x", d => d.x1 + 6);
                
                // Add value labels with animation
                const valueLabels = nodeGroup.selectAll(".value-counter")
                    .data(d => [d]);
                
                valueLabels.exit().remove();
                
                const valueLabelsEnter = valueLabels.enter()
                    .append("text")
                    .attr("class", "value-counter")
                    .attr("x", d => d.x0 - 6)
                    .attr("y", d => (d.y1 + d.y0) / 2 + 8)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "end")
                    .attr("font-size", "10px")
                    .attr("fill", "#ccc")
                    .text("")
                    .filter(d => d.x0 < width / 2)
                    .attr("x", d => d.x1 + 6)
                    .attr("text-anchor", "start");
                
                // Animate value counters
                valueLabelsEnter.each(function(d, i) {
                    const element = d3.select(this);
                    let totalValue = 0;
                    
                    if (incomeSources.some(source => source.name === d.name)) {
                        const source = incomeSources.find(source => source.name === d.name);
                        totalValue = source ? source.amount : 0;
                    } else if (categoryTotals[d.name]) {
                        totalValue = categoryTotals[d.name] * 12;
                    } else if (d.name === "Budget") {
                        totalValue = incomeSources.reduce((sum, source) => sum + source.amount, 0);
                    } else {
                        const subcategoryValue = subcategoryTotals[d.name];
                        if (subcategoryValue) {
                            totalValue = subcategoryValue * 12;
                        }
                    }
                    
                    if (totalValue > 0) {
                        element.transition()
                            .delay(300)
                            .duration(800)
                            .tween("text", function() {
                                const interpolator = d3.interpolateNumber(0, totalValue);
                                return function(t) {
                                    const currentValue = interpolator(t);
                                    element.text(`$${Math.round(currentValue).toLocaleString()}`)
                                        .classed("animating", t < 0.1);
                                };
                            });
                    }
                });
            }
                
        } catch (error) {
            console.error('Error creating Sankey chart:', error);
            console.error('Error details:', error.message);
            chartContainer.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px;">Error creating chart. Please check the console for details.</div>';
        }
    }
</script>
</body>
</html> 