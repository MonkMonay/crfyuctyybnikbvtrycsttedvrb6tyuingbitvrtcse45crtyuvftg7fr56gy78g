<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" />
    <title>Dashboard - BonoBudget</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
         crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #222;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-radius: 0 0 20px 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .nav {
            display: flex;
            gap: 30px;
        }
        
        .nav-item {
            color: #ccc;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #333;
            color: #fff;
        }
        
        .nav-item.active {
            background: #4caf50;
            color: #fff;
        }
        
        .profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-email {
            color: #ccc;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: #ff5252;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        
        .welcome-text {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        /* Google Ads Styling */
        .ads-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }
        
        .ad-sidebar {
            width: 300px;
            min-height: 600px;
            background: #222;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .ad-banner {
            width: 100%;
            height: 90px;
            background: #333;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ccc;
        }
        
        .main-content {
            flex: 1;
            background: #222;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .panel {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 24px;
        }

        .panel-title {
            margin: 0 0 16px;
            font-size: 20px;
            color: #4caf50;
        }

        .sankey-container {
            width: 100%;
            min-height: 430px;
            position: relative;
        }

        .empty-state {
            background: #1c1c1c;
            border: 1px dashed #444;
            border-radius: 12px;
            color: #bbb;
            padding: 24px;
            text-align: center;
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .checklist {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checklist-item {
            background: #333;
            border: 1px solid #3f3f3f;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .checklist-item strong {
            display: block;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .checklist-item span {
            font-size: 12px;
            color: #aaa;
            line-height: 1.35;
        }

        .status-pill {
            border-radius: 999px;
            padding: 3px 9px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2px;
            white-space: nowrap;
        }

        .status-done {
            background: rgba(76, 175, 80, 0.18);
            color: #7de281;
            border: 1px solid rgba(76, 175, 80, 0.45);
        }

        .status-progress {
            background: rgba(255, 193, 7, 0.16);
            color: #ffda68;
            border: 1px solid rgba(255, 193, 7, 0.45);
        }

        .status-next {
            background: rgba(33, 150, 243, 0.16);
            color: #81c9ff;
            border: 1px solid rgba(33, 150, 243, 0.45);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .muted {
            color: #9f9f9f;
            font-size: 12px;
        }

        .stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row-line {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            background: #333;
            border: 1px solid #3e3e3e;
            border-radius: 10px;
            padding: 10px;
        }

        .row-main {
            font-size: 13px;
            color: #ddd;
        }

        .row-sub {
            color: #9f9f9f;
            font-size: 12px;
        }

        .inline-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            margin-top: 12px;
        }

        .inline-form-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            margin-top: 12px;
        }

        .form-input,
        .form-select {
            width: 100%;
            background: #1f1f1f;
            color: #fff;
            border: 1px solid #3d3d3d;
            border-radius: 10px;
            padding: 10px;
            font-size: 13px;
        }

        .form-btn {
            border: none;
            border-radius: 10px;
            background: #4caf50;
            color: #fff;
            padding: 10px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .form-btn.alt {
            background: #2196f3;
        }

        .form-btn.warn {
            background: #ef5350;
        }

        .pill-good {
            color: #8bf0a0;
        }

        .pill-bad {
            color: #ff9a9a;
        }

        .pill-warn {
            color: #ffd36e;
        }

        .progress-track {
            width: 100%;
            height: 8px;
            background: #222;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 6px;
        }

        .progress-bar-small {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
        }
        
        .content-wrapper {
            display: flex;
            gap: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .ad-sidebar {
                width: 100%;
                min-height: auto;
            }

            .checklist-grid {
                grid-template-columns: 1fr;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }

            .inline-form,
            .inline-form-4 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">Bonobudget</div>
        <div class="nav">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item" onclick="window.location.href='bank.html'">Bank</div>
            <div class="nav-item" onclick="window.location.href='goals.html'">Goals</div>
        </div>
        <div class="profile">
            <div class="profile-email" id="userEmail"></div>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="welcome-text" id="welcome"></div>
        
        <div class="content-wrapper">
            <!-- Left Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <h2 style="color:#4caf50;text-align:center;margin-top:10px;">Your Financial Overview</h2>
                
                <!-- Summary Cards -->
                <div id="summaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <!-- Time Period Display -->
                <div id="timePeriod" style="text-align: center; color: #999; margin-bottom: 20px; font-size: 14px;">
                    Annual Overview
                </div>

                <div class="panel" style="margin-bottom: 30px;">
                    <h3 class="panel-title">Money Flow (Sankey)</h3>
                    <div id="chartEmptyState" class="empty-state" style="display: none;"></div>
                    <div id="sankeyChart" class="sankey-container"></div>
                </div>
                
                <!-- Charts Container -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <!-- Income Chart -->
                    <div class="panel">
                        <h3 style="color: #4caf50; text-align: center; margin-bottom: 20px; font-size: 20px;">Income Sources</h3>
                        <div id="incomeChart" style="width: 100%; height: 350px;"></div>
                        <div id="incomeLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                    
                    <!-- Expenses Chart -->
                    <div class="panel">
                        <h3 style="color: #ff5252; text-align: center; margin-bottom: 20px; font-size: 20px;">Expense Categories</h3>
                        <div id="expenseChart" style="width: 100%; height: 350px;"></div>
                        <div id="expenseLegend" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
                    </div>
                </div>

                <div class="checklist-grid">
                    <div class="panel">
                        <h3 class="panel-title">Next Best Actions</h3>
                        <ul id="actionChecklist" class="checklist"></ul>
                    </div>
                    <div class="panel">
                        <h3 class="panel-title">Budget App Excellence Roadmap</h3>
                        <ul id="productRoadmap" class="checklist"></ul>
                    </div>
                </div>

                <div class="feature-grid">
                    <div class="panel">
                        <h3 class="panel-title">Category Budgets</h3>
                        <div class="muted">Set monthly targets and compare against your current monthly spending.</div>
                        <div id="budgetTargetsList" class="stack" style="margin-top: 12px;"></div>
                        <div class="inline-form">
                            <select id="budgetCategoryInput" class="form-select"></select>
                            <input id="budgetAmountInput" class="form-input" type="number" min="0" step="1" placeholder="Monthly target ($)">
                            <button id="saveBudgetBtn" class="form-btn">Save</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 class="panel-title">Goal Buckets</h3>
                        <div class="muted">Track sinking funds and long-term targets with monthly contributions.</div>
                        <div id="goalBucketsList" class="stack" style="margin-top: 12px;"></div>
                        <div class="inline-form-4">
                            <input id="goalNameInput" class="form-input" placeholder="Goal name">
                            <input id="goalTargetInput" class="form-input" type="number" min="1" step="1" placeholder="Target ($)">
                            <input id="goalMonthlyInput" class="form-input" type="number" min="0" step="1" placeholder="Monthly ($)">
                            <button id="addGoalBtn" class="form-btn">Add Goal</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 class="panel-title">Bill Calendar</h3>
                        <div class="muted">Keep recurring bills visible by due day to avoid surprises.</div>
                        <div id="billCalendarList" class="stack" style="margin-top: 12px;"></div>
                        <div class="inline-form-4">
                            <input id="billNameInput" class="form-input" placeholder="Bill name">
                            <input id="billAmountInput" class="form-input" type="number" min="0" step="1" placeholder="Amount ($)">
                            <input id="billDayInput" class="form-input" type="number" min="1" max="31" step="1" placeholder="Due day">
                            <button id="addBillBtn" class="form-btn">Add Bill</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 class="panel-title">Alert Engine</h3>
                        <div class="muted">Automatic warnings and guidance based on your live budget data.</div>
                        <div id="alertEngineList" class="stack" style="margin-top: 12px;"></div>
                    </div>

                    <div class="panel">
                        <h3 class="panel-title">Shared Budgets</h3>
                        <div class="muted">Invite household collaborators and assign simple roles.</div>
                        <div id="sharedMembersList" class="stack" style="margin-top: 12px;"></div>
                        <div class="inline-form">
                            <input id="sharedEmailInput" class="form-input" type="email" placeholder="Email address">
                            <select id="sharedRoleInput" class="form-select">
                                <option value="Viewer">Viewer</option>
                                <option value="Editor">Editor</option>
                                <option value="Owner">Owner</option>
                            </select>
                            <button id="addMemberBtn" class="form-btn">Invite</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 class="panel-title">Exports & Reports</h3>
                        <div class="muted">Download your budget snapshot for reviews, planning, or tax prep.</div>
                        <div class="inline-form" style="margin-top: 14px;">
                            <button id="exportCsvBtn" class="form-btn alt">Export CSV</button>
                            <button id="exportJsonBtn" class="form-btn alt">Export JSON</button>
                            <button id="printReportBtn" class="form-btn">Print Report</button>
                        </div>
                        <div id="exportSummary" class="stack" style="margin-top: 12px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar Ads -->
            <div class="ad-sidebar">
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Top -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Middle -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="ad-banner">
                    <!-- Google AdSense - Right Sidebar Bottom -->
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2901233728197269"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        </div>
        
        <!-- Bottom Banner Ad -->
        <div style="margin-top: 30px; text-align: center;">
            <div class="ad-banner" style="height: 120px; margin: 0 auto; max-width: 728px;">
                <!-- Google AdSense - Bottom Banner -->
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2901233728197269"
                     crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2901233728197269"
                     data-ad-slot="YOUR_AD_SLOT_ID"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        #incomeChart, #expenseChart {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .chart-tooltip {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        @media (max-width: 1200px) {
            .main-content > div:last-child {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZhftowlNqPvBMuWJ-5NWqfA-Yb59TehQ",
      authDomain: "bonobudget.firebaseapp.com",
      projectId: "bonobudget",
      storageBucket: "bonobudget.firebasestorage.app",
      messagingSenderId: "42259683918",
      appId: "1:42259683918:web:ab931da84be09ffa69811f",
      measurementId: "G-ZBM8LKGR01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const welcome = document.getElementById('welcome');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Spending categories matching the bank page structure
    const spendingCategories = [
        { title: "Income", items: [
            { label: "Primary Income Source" },
            { label: "Primary Monthly Income" },
            { label: "Has Additional Income" },
            { label: "Additional Income Sources" },
            { label: "Additional Monthly Income" },
            { label: "Total Monthly Income" },
            { label: "Has Irregular Income" },
            { label: "Irregular Income Types" },
            { label: "Annual Irregular Income" },
            { label: "Total Annual Income" }
        ]},
        { title: "Housing", items: [
            { label: "Rent/Mortgage" },
            { label: "Mortgage Interest Rate" },
            { label: "Mortgage Principal" },
            { label: "Property Taxes" },
            { label: "Home Insurance" },
            { label: "Utilities (Electricity, Water, Gas)" },
            { label: "Internet & Phone" },
            { label: "Maintenance/Repairs" },
            { label: "HOA Fees" }
        ]},
        { title: "Transportation", items: [
            { label: "Car Payment/Lease" },
            { label: "Gas/Fuel" },
            { label: "Car Insurance" },
            { label: "Maintenance/Repairs" },
            { label: "Public Transportation" },
            { label: "Parking Fees" },
            { label: "Uber/Lyft" }
        ]},
        { title: "Food & Dining", items: [
            { label: "Groceries" },
            { label: "Restaurants" },
            { label: "Fast Food" },
            { label: "Coffee Shops" },
            { label: "Food Delivery" },
            { label: "Alcohol/Bars" }
        ]},
        { title: "Personal & Health", items: [
            { label: "Health Insurance" },
            { label: "Doctor Visits" },
            { label: "Prescriptions" },
            { label: "Dental Care" },
            { label: "Vision Care" },
            { label: "Gym Membership" },
            { label: "Haircuts/Salon" },
            { label: "Personal Hygiene Products" },
            { label: "Clothing/Shoes" },
            { label: "Cosmetics/Beauty" }
        ]},
        { title: "Entertainment & Lifestyle", items: [
            { label: "Streaming Services" },
            { label: "Movies/Theater" },
            { label: "Concerts/Events" },
            { label: "Books/Magazines" },
            { label: "Video Games" },
            { label: "Hobbies" },
            { label: "Vacations" },
            { label: "Hotels" },
            { label: "Flights" },
            { label: "Car Rentals" },
            { label: "Travel Insurance" }
        ]},
        { title: "Financial Obligations", items: [
            { label: "Credit Cards" },
            { label: "Student Loans" },
            { label: "Personal Loans" },
            { label: "Medical Debt" },
            { label: "Emergency Fund" },
            { label: "Retirement Savings" },
            { label: "Investment Accounts" },
            { label: "College Savings" }
        ]},
        { title: "Other", items: [
            { label: "Tuition" },
            { label: "Books/Supplies" },
            { label: "Courses/Certifications" },
            { label: "Birthday/Holiday Gifts" },
            { label: "Charitable Donations" },
            { label: "Wedding Gifts" },
            { label: "Life Insurance" },
            { label: "Disability Insurance" },
            { label: "Pet Insurance" },
            { label: "Pet Food" },
            { label: "Vet Visits" },
            { label: "Pet Supplies" }
        ]}
    ];

    const chartEmptyState = document.getElementById('chartEmptyState');
    const sankeyChartContainer = document.getElementById('sankeyChart');
    let latestModel = null;
    let planningData = { budgets: {}, goals: [], bills: [], members: [] };
    let currentUid = null;
    let sankeyResizeTimer = null;
    let isSankeyResizeBound = false;
    let isFeatureHandlersBound = false;

    const budgetTargetsList = document.getElementById('budgetTargetsList');
    const budgetCategoryInput = document.getElementById('budgetCategoryInput');
    const budgetAmountInput = document.getElementById('budgetAmountInput');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');

    const goalBucketsList = document.getElementById('goalBucketsList');
    const goalNameInput = document.getElementById('goalNameInput');
    const goalTargetInput = document.getElementById('goalTargetInput');
    const goalMonthlyInput = document.getElementById('goalMonthlyInput');
    const addGoalBtn = document.getElementById('addGoalBtn');

    const billCalendarList = document.getElementById('billCalendarList');
    const billNameInput = document.getElementById('billNameInput');
    const billAmountInput = document.getElementById('billAmountInput');
    const billDayInput = document.getElementById('billDayInput');
    const addBillBtn = document.getElementById('addBillBtn');

    const alertEngineList = document.getElementById('alertEngineList');

    const sharedMembersList = document.getElementById('sharedMembersList');
    const sharedEmailInput = document.getElementById('sharedEmailInput');
    const sharedRoleInput = document.getElementById('sharedRoleInput');
    const addMemberBtn = document.getElementById('addMemberBtn');

    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const printReportBtn = document.getElementById('printReportBtn');
    const exportSummary = document.getElementById('exportSummary');

    auth.onAuthStateChanged(function(user) {
        if (user) {
            currentUid = user.uid;
            welcome.textContent = `You're logged in as: ${user.email}`;
            userEmail.textContent = user.email;
            initializeFeatureHandlers();
            loadSankeyData(user.uid);
        } else {
            window.location.href = 'login.html';
        }
    });

    logoutBtn.onclick = function() {
        auth.signOut();
    };

    function toAmount(value) {
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatMoney(value) {
        return `$${Math.round(toAmount(value)).toLocaleString()}`;
    }

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function createId(prefix) {
        return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
    }

    function getExpenseCategories(model) {
        const categories = spendingCategories
            .filter(category => category.title !== 'Income')
            .map(category => category.title);
        if (model && model.categoryTotals && model.categoryTotals.Savings > 0) {
            categories.push('Savings');
        }
        return Array.from(new Set(categories));
    }

    function normalizePlanningData(rawData, model) {
        const safeRaw = rawData || {};
        const categories = getExpenseCategories(model);
        const budgets = {};

        categories.forEach(category => {
            const existing = toAmount(safeRaw.budgets?.[category]);
            const baseline = toAmount(model?.categoryTotals?.[category]);
            if (existing > 0) {
                budgets[category] = existing;
            } else if (baseline > 0) {
                budgets[category] = Math.ceil(baseline / 10) * 10;
            } else {
                budgets[category] = 0;
            }
        });

        const goals = Array.isArray(safeRaw.goals) ? safeRaw.goals
            .map(goal => ({
                id: goal.id || createId('goal'),
                name: String(goal.name || '').trim(),
                target: toAmount(goal.target),
                current: toAmount(goal.current),
                monthly: toAmount(goal.monthly)
            }))
            .filter(goal => goal.name && goal.target > 0) : [];

        const bills = Array.isArray(safeRaw.bills) ? safeRaw.bills
            .map(bill => ({
                id: bill.id || createId('bill'),
                name: String(bill.name || '').trim(),
                amount: toAmount(bill.amount),
                dueDay: Math.min(31, Math.max(1, Math.round(toAmount(bill.dueDay))))
            }))
            .filter(bill => bill.name && bill.amount > 0) : [];

        const members = Array.isArray(safeRaw.members) ? safeRaw.members
            .map(member => ({
                id: member.id || createId('member'),
                email: String(member.email || '').trim().toLowerCase(),
                role: String(member.role || 'Viewer'),
                status: String(member.status || 'Pending')
            }))
            .filter(member => member.email) : [];

        return { budgets, goals, bills, members };
    }

    async function savePlanningData() {
        if (!currentUid) return;
        try {
            await db.collection('users').doc(currentUid).collection('planning').doc('dashboard').set(planningData);
        } catch (error) {
            console.error('Error saving planning data:', error);
        }
    }

    function seedBudgetCategorySelect(model) {
        const categories = getExpenseCategories(model);
        const currentValue = budgetCategoryInput.value;
        budgetCategoryInput.innerHTML = '';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            budgetCategoryInput.appendChild(option);
        });
        if (categories.includes(currentValue)) {
            budgetCategoryInput.value = currentValue;
        }
    }

    function renderBudgetTargets(model) {
        seedBudgetCategorySelect(model);
        budgetTargetsList.innerHTML = '';
        const categories = getExpenseCategories(model);

        categories.forEach(category => {
            const actual = toAmount(model?.categoryTotals?.[category]);
            const target = toAmount(planningData.budgets?.[category]);
            const delta = target - actual;
            const statusClass = target <= 0 ? 'pill-warn' : (delta >= 0 ? 'pill-good' : 'pill-bad');
            const statusText = target <= 0 ? 'No target set' : (delta >= 0 ? `${formatMoney(delta)} under` : `${formatMoney(Math.abs(delta))} over`);

            const row = document.createElement('div');
            row.className = 'row-line';
            row.innerHTML = `
                <div>
                    <div class="row-main">${escapeHtml(category)}</div>
                    <div class="row-sub">Actual: ${formatMoney(actual)} / mo • Target: ${formatMoney(target)} / mo</div>
                </div>
                <div class="${statusClass}" style="font-size:12px; font-weight:600;">${statusText}</div>
            `;
            budgetTargetsList.appendChild(row);
        });

        const selectedAmount = toAmount(planningData.budgets?.[budgetCategoryInput.value]);
        budgetAmountInput.value = selectedAmount > 0 ? String(selectedAmount) : '';
    }

    function renderGoalBuckets() {
        goalBucketsList.innerHTML = '';
        if (!planningData.goals.length) {
            goalBucketsList.innerHTML = '<div class="empty-state">No goals yet. Add your first goal bucket.</div>';
            return;
        }

        planningData.goals.forEach(goal => {
            const progress = goal.target > 0 ? Math.min(100, (goal.current / goal.target) * 100) : 0;
            const row = document.createElement('div');
            row.className = 'row-line';
            row.innerHTML = `
                <div style="flex:1;">
                    <div class="row-main">${escapeHtml(goal.name)}</div>
                    <div class="row-sub">${formatMoney(goal.current)} of ${formatMoney(goal.target)} • Monthly: ${formatMoney(goal.monthly)}</div>
                    <div class="progress-track">
                        <div class="progress-bar-small" style="width:${progress.toFixed(1)}%;"></div>
                    </div>
                </div>
                <button class="form-btn warn" data-remove-goal="${escapeHtml(goal.id)}">Remove</button>
            `;
            goalBucketsList.appendChild(row);
        });
    }

    function renderBillCalendar(model) {
        billCalendarList.innerHTML = '';
        const sortedBills = [...planningData.bills].sort((a, b) => a.dueDay - b.dueDay);
        if (!sortedBills.length) {
            billCalendarList.innerHTML = '<div class="empty-state">No recurring bills yet.</div>';
            return;
        }

        sortedBills.forEach(bill => {
            const row = document.createElement('div');
            row.className = 'row-line';
            row.innerHTML = `
                <div>
                    <div class="row-main">${escapeHtml(bill.name)}</div>
                    <div class="row-sub">Due day ${bill.dueDay} • ${formatMoney(bill.amount)} / mo</div>
                </div>
                <button class="form-btn warn" data-remove-bill="${escapeHtml(bill.id)}">Remove</button>
            `;
            billCalendarList.appendChild(row);
        });

        const billTotal = sortedBills.reduce((sum, bill) => sum + toAmount(bill.amount), 0);
        const monthlyIncome = model ? (toAmount(model.totalIncome) / 12) : 0;
        const ratio = monthlyIncome > 0 ? ((billTotal / monthlyIncome) * 100).toFixed(1) : '0.0';
        const info = document.createElement('div');
        info.className = 'row-sub';
        info.style.marginTop = '8px';
        info.textContent = `Fixed bills: ${formatMoney(billTotal)} / mo (${ratio}% of monthly income)`;
        billCalendarList.appendChild(info);
    }

    function renderSharedMembers() {
        sharedMembersList.innerHTML = '';
        if (!planningData.members.length) {
            sharedMembersList.innerHTML = '<div class="empty-state">No collaborators yet.</div>';
            return;
        }

        planningData.members.forEach(member => {
            const row = document.createElement('div');
            row.className = 'row-line';
            row.innerHTML = `
                <div>
                    <div class="row-main">${escapeHtml(member.email)}</div>
                    <div class="row-sub">${escapeHtml(member.role)} • ${escapeHtml(member.status)}</div>
                </div>
                <button class="form-btn warn" data-remove-member="${escapeHtml(member.id)}">Remove</button>
            `;
            sharedMembersList.appendChild(row);
        });
    }

    function renderAlerts(model) {
        alertEngineList.innerHTML = '';
        const alerts = [];

        if (!model) {
            alerts.push({ level: 'pill-warn', text: 'Complete Bank setup to unlock automated alerts.' });
        } else {
            const monthlyIncome = toAmount(model.totalIncome) / 12;
            const monthlyExpenses = toAmount(model.totalExpenses) / 12;
            const housingRatio = monthlyIncome > 0 ? (toAmount(model.categoryTotals.Housing) / monthlyIncome) : 0;
            const emergencyFund = toAmount(window.sankeyData?.['Emergency Fund']);
            const totalBills = planningData.bills.reduce((sum, bill) => sum + toAmount(bill.amount), 0);

            if (model.surplus < 0) {
                alerts.push({ level: 'pill-bad', text: `Deficit detected: ${formatMoney(Math.abs(model.surplus) / 12)} per month.` });
            }
            if (housingRatio > 0.35) {
                alerts.push({ level: 'pill-warn', text: `Housing is ${(housingRatio * 100).toFixed(1)}% of income (target <= 35%).` });
            }
            if (emergencyFund <= 0) {
                alerts.push({ level: 'pill-warn', text: 'No emergency fund contribution detected this month.' });
            }

            Object.keys(planningData.budgets || {}).forEach(category => {
                const target = toAmount(planningData.budgets[category]);
                const actual = toAmount(model.categoryTotals[category]);
                if (target > 0 && actual > target) {
                    alerts.push({ level: 'pill-bad', text: `${category} is over target by ${formatMoney(actual - target)} this month.` });
                }
            });

            if (monthlyIncome > 0 && totalBills > (monthlyIncome * 0.7)) {
                alerts.push({ level: 'pill-warn', text: `Bills are ${((totalBills / monthlyIncome) * 100).toFixed(1)}% of monthly income.` });
            }

            if (!alerts.length) {
                alerts.push({ level: 'pill-good', text: 'No critical alerts. Budget health looks stable right now.' });
            }

            const goalsMonthly = planningData.goals.reduce((sum, goal) => sum + toAmount(goal.monthly), 0);
            if (goalsMonthly > 0 && (monthlyIncome - monthlyExpenses) < goalsMonthly) {
                alerts.push({ level: 'pill-warn', text: 'Goal contributions exceed current monthly surplus. Consider reducing goal pace.' });
            }
        }

        alerts.forEach(alert => {
            const row = document.createElement('div');
            row.className = 'row-line';
            row.innerHTML = `<div class="${alert.level}" style="font-size:13px; font-weight:600;">${escapeHtml(alert.text)}</div>`;
            alertEngineList.appendChild(row);
        });
    }

    function renderExportSummary(model) {
        exportSummary.innerHTML = '';
        const monthlyIncome = model ? toAmount(model.totalIncome) / 12 : 0;
        const monthlyExpenses = model ? toAmount(model.totalExpenses) / 12 : 0;
        const summaryRows = [
            `Monthly income: ${formatMoney(monthlyIncome)}`,
            `Monthly expenses: ${formatMoney(monthlyExpenses)}`,
            `Saved budgets: ${Object.keys(planningData.budgets || {}).filter(key => toAmount(planningData.budgets[key]) > 0).length}`,
            `Goal buckets: ${planningData.goals.length}`,
            `Recurring bills: ${planningData.bills.length}`,
            `Collaborators: ${planningData.members.length}`
        ];
        summaryRows.forEach(text => {
            const row = document.createElement('div');
            row.className = 'row-sub';
            row.textContent = text;
            exportSummary.appendChild(row);
        });
    }

    function renderPlanningPanels(model) {
        renderBudgetTargets(model);
        renderGoalBuckets();
        renderBillCalendar(model);
        renderSharedMembers();
        renderAlerts(model);
        renderExportSummary(model);
    }

    function downloadTextFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType || 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
    }

    function buildExportPayload() {
        const model = latestModel || null;
        const monthlyIncome = model ? toAmount(model.totalIncome) / 12 : 0;
        const monthlyExpenses = model ? toAmount(model.totalExpenses) / 12 : 0;
        const payload = {
            generatedAt: new Date().toISOString(),
            summary: {
                annualIncome: toAmount(model?.totalIncome),
                annualExpenses: toAmount(model?.totalExpenses),
                annualSurplus: toAmount(model?.surplus),
                monthlyIncome,
                monthlyExpenses
            },
            categoryActualMonthly: model?.categoryTotals || {},
            categoryBudgetsMonthly: planningData.budgets || {},
            goals: planningData.goals || [],
            bills: planningData.bills || [],
            collaborators: planningData.members || []
        };
        return payload;
    }

    function initializeFeatureHandlers() {
        if (isFeatureHandlersBound) return;
        isFeatureHandlersBound = true;

        saveBudgetBtn.addEventListener('click', async () => {
            const category = budgetCategoryInput.value;
            const amount = toAmount(budgetAmountInput.value);
            if (!category) return;
            planningData.budgets[category] = amount;
            budgetAmountInput.value = '';
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        budgetCategoryInput.addEventListener('change', () => {
            const amount = toAmount(planningData.budgets?.[budgetCategoryInput.value]);
            budgetAmountInput.value = amount > 0 ? String(amount) : '';
        });

        addGoalBtn.addEventListener('click', async () => {
            const name = goalNameInput.value.trim();
            const target = toAmount(goalTargetInput.value);
            const monthly = toAmount(goalMonthlyInput.value);
            if (!name || target <= 0) return;

            planningData.goals.push({
                id: createId('goal'),
                name,
                target,
                current: 0,
                monthly
            });
            goalNameInput.value = '';
            goalTargetInput.value = '';
            goalMonthlyInput.value = '';
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        addBillBtn.addEventListener('click', async () => {
            const name = billNameInput.value.trim();
            const amount = toAmount(billAmountInput.value);
            const dueDay = Math.min(31, Math.max(1, Math.round(toAmount(billDayInput.value))));
            if (!name || amount <= 0) return;

            planningData.bills.push({
                id: createId('bill'),
                name,
                amount,
                dueDay
            });
            billNameInput.value = '';
            billAmountInput.value = '';
            billDayInput.value = '';
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        addMemberBtn.addEventListener('click', async () => {
            const email = sharedEmailInput.value.trim().toLowerCase();
            const role = sharedRoleInput.value;
            if (!email || !email.includes('@')) return;
            if (planningData.members.some(member => member.email === email)) return;

            planningData.members.push({
                id: createId('member'),
                email,
                role,
                status: 'Pending'
            });
            sharedEmailInput.value = '';
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        goalBucketsList.addEventListener('click', async event => {
            const button = event.target.closest('[data-remove-goal]');
            if (!button) return;
            const id = button.getAttribute('data-remove-goal');
            planningData.goals = planningData.goals.filter(goal => goal.id !== id);
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        billCalendarList.addEventListener('click', async event => {
            const button = event.target.closest('[data-remove-bill]');
            if (!button) return;
            const id = button.getAttribute('data-remove-bill');
            planningData.bills = planningData.bills.filter(bill => bill.id !== id);
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        sharedMembersList.addEventListener('click', async event => {
            const button = event.target.closest('[data-remove-member]');
            if (!button) return;
            const id = button.getAttribute('data-remove-member');
            planningData.members = planningData.members.filter(member => member.id !== id);
            await savePlanningData();
            renderPlanningPanels(latestModel);
        });

        exportCsvBtn.addEventListener('click', () => {
            const payload = buildExportPayload();
            const rows = [
                ['Metric', 'Value'],
                ['Generated At', payload.generatedAt],
                ['Annual Income', payload.summary.annualIncome],
                ['Annual Expenses', payload.summary.annualExpenses],
                ['Annual Surplus', payload.summary.annualSurplus],
                ['Monthly Income', payload.summary.monthlyIncome],
                ['Monthly Expenses', payload.summary.monthlyExpenses],
                ['---', '---'],
                ['Category', 'Actual Monthly'],
                ...Object.entries(payload.categoryActualMonthly).map(([category, value]) => [category, value]),
                ['---', '---'],
                ['Category', 'Budget Monthly'],
                ...Object.entries(payload.categoryBudgetsMonthly).map(([category, value]) => [category, value]),
                ['---', '---'],
                ['Goal Name', 'Target'],
                ...payload.goals.map(goal => [goal.name, goal.target]),
                ['---', '---'],
                ['Bill Name', 'Amount'],
                ...payload.bills.map(bill => [bill.name, bill.amount])
            ];
            const csv = rows.map(row => row.map(col => `"${String(col).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadTextFile('bonobudget-report.csv', csv, 'text/csv;charset=utf-8');
        });

        exportJsonBtn.addEventListener('click', () => {
            const payload = buildExportPayload();
            downloadTextFile('bonobudget-report.json', JSON.stringify(payload, null, 2), 'application/json;charset=utf-8');
        });

        printReportBtn.addEventListener('click', () => {
            const payload = buildExportPayload();
            const reportWindow = window.open('', '_blank', 'width=900,height=700');
            if (!reportWindow) return;

            reportWindow.document.write(`
                <html>
                    <head>
                        <title>Bonobudget Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 24px; color: #111; }
                            h1, h2 { margin: 0 0 12px; }
                            .section { margin-top: 22px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 8px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
                            th { background: #f4f4f4; }
                        </style>
                    </head>
                    <body>
                        <h1>Bonobudget Financial Report</h1>
                        <div>Generated: ${escapeHtml(payload.generatedAt)}</div>
                        <div class="section">
                            <h2>Summary</h2>
                            <table>
                                <tr><th>Metric</th><th>Value</th></tr>
                                <tr><td>Annual Income</td><td>${formatMoney(payload.summary.annualIncome)}</td></tr>
                                <tr><td>Annual Expenses</td><td>${formatMoney(payload.summary.annualExpenses)}</td></tr>
                                <tr><td>Annual Surplus</td><td>${formatMoney(payload.summary.annualSurplus)}</td></tr>
                            </table>
                        </div>
                        <div class="section">
                            <h2>Category Actuals (Monthly)</h2>
                            <table>
                                <tr><th>Category</th><th>Actual</th></tr>
                                ${Object.entries(payload.categoryActualMonthly).map(([category, value]) => `<tr><td>${escapeHtml(category)}</td><td>${formatMoney(value)}</td></tr>`).join('')}
                            </table>
                        </div>
                        <div class="section">
                            <h2>Category Budgets (Monthly)</h2>
                            <table>
                                <tr><th>Category</th><th>Budget</th></tr>
                                ${Object.entries(payload.categoryBudgetsMonthly).map(([category, value]) => `<tr><td>${escapeHtml(category)}</td><td>${formatMoney(value)}</td></tr>`).join('')}
                            </table>
                        </div>
                    </body>
                </html>
            `);
            reportWindow.document.close();
            reportWindow.focus();
            reportWindow.print();
        });
    }

    function showChartState(message) {
        chartEmptyState.style.display = 'block';
        chartEmptyState.textContent = message;
        sankeyChartContainer.innerHTML = '';
    }

    function hideChartState() {
        chartEmptyState.style.display = 'none';
        chartEmptyState.textContent = '';
    }

    function renderSummaryMessage(message) {
        document.getElementById('summaryCards').innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">${message}</div>`;
        document.getElementById('incomeChart').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
        document.getElementById('expenseChart').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
        document.getElementById('incomeLegend').innerHTML = '';
        document.getElementById('expenseLegend').innerHTML = '';
    }

    function buildFinancialModel(data) {
        const incomeSources = [];
        const primaryIncome = toAmount(data['Primary Monthly Income']);
        const additionalIncome = toAmount(data['Additional Monthly Income']);
        const irregularIncome = toAmount(data['Annual Irregular Income']);
        const fallbackMonthlyIncome = toAmount(data['Total Monthly Income']);
        const fallbackAnnualIncome = toAmount(data['Total Annual Income']);

        if (primaryIncome > 0) {
            incomeSources.push({
                name: data['Primary Income Source'] || 'Primary Income',
                value: primaryIncome * 12
            });
        }
        if (additionalIncome > 0) {
            incomeSources.push({
                name: 'Additional Income',
                value: additionalIncome * 12
            });
        }
        if (irregularIncome > 0) {
            incomeSources.push({
                name: 'Irregular Income',
                value: irregularIncome
            });
        }
        if (incomeSources.length === 0 && fallbackMonthlyIncome > 0) {
            incomeSources.push({ name: 'Total Income', value: fallbackMonthlyIncome * 12 });
        }
        if (incomeSources.length === 0 && fallbackAnnualIncome > 0) {
            incomeSources.push({ name: 'Total Income', value: fallbackAnnualIncome });
        }

        const categoryTotals = {};
        const subcategoryTotals = {};
        const savingsItems = new Set(['Emergency Fund', 'Retirement Savings', 'Investment Accounts', 'College Savings']);
        const nonSpendFields = new Set(['Mortgage Interest Rate']);
        let totalSavingsMonthly = 0;
        let answeredCount = 0;

        Object.keys(data || {}).forEach(key => {
            const value = data[key];
            if (value !== undefined && value !== null && value !== '' && value !== 'skipped') {
                answeredCount += 1;
            }
        });

        for (const category of spendingCategories) {
            if (category.title === 'Income') continue;

            let categoryTotal = 0;
            for (const item of category.items) {
                if (item.label === 'Mortgage Principal' || nonSpendFields.has(item.label)) continue;
                const raw = data[item.label];
                const numeric = toAmount(raw);
                if (!raw || raw === 'skipped' || numeric <= 0) continue;

                if (savingsItems.has(item.label)) {
                    totalSavingsMonthly += numeric;
                } else {
                    categoryTotal += numeric;
                }
                subcategoryTotals[item.label] = numeric;
            }

            if (category.title === 'Housing') {
                const mortgagePrincipal = toAmount(data['Mortgage Principal']);
                if (mortgagePrincipal > 0) {
                    categoryTotal += mortgagePrincipal;
                    subcategoryTotals['Mortgage Principal'] = mortgagePrincipal;
                }
            }

            if (categoryTotal > 0) {
                categoryTotals[category.title] = categoryTotal;
            }
        }

        if (totalSavingsMonthly > 0) {
            categoryTotals['Savings'] = totalSavingsMonthly;
        }

        const totalIncome = incomeSources.reduce((sum, source) => sum + source.value, 0);
        const totalExpenses = Object.values(categoryTotals).reduce((sum, monthly) => sum + (monthly * 12), 0);
        const surplus = totalIncome - totalExpenses;

        return {
            incomeSources,
            categoryTotals,
            subcategoryTotals,
            totalIncome,
            totalExpenses,
            surplus,
            answeredCount
        };
    }

    function getChartTooltip() {
        let tooltip = d3.select('#chartTooltip');
        if (tooltip.empty()) {
            tooltip = d3.select('body').append('div')
                .attr('id', 'chartTooltip')
                .attr('class', 'chart-tooltip')
                .style('opacity', 0)
                .style('position', 'absolute')
                .style('background', 'rgba(0, 0, 0, 0.9)')
                .style('color', '#fff')
                .style('padding', '12px')
                .style('border-radius', '8px')
                .style('pointer-events', 'none')
                .style('font-size', '13px')
                .style('z-index', '10000');
        }
        return tooltip;
    }

    function bindSankeyResize() {
        if (isSankeyResizeBound) return;
        isSankeyResizeBound = true;
        window.addEventListener('resize', () => {
            clearTimeout(sankeyResizeTimer);
            sankeyResizeTimer = setTimeout(() => {
                if (latestModel && latestModel.totalIncome > 0 && Object.keys(latestModel.categoryTotals).length > 0) {
                    createSankeyChart(latestModel);
                }
            }, 180);
        });
    }

    async function loadSankeyData(uid) {
        showChartState('Loading your money flow...');
        renderProductRoadmap();
        try {
            const [spendingDoc, planningDoc] = await Promise.all([
                db.collection('users').doc(uid).collection('spending').doc('categories').get(),
                db.collection('users').doc(uid).collection('planning').doc('dashboard').get()
            ]);

            if (!spendingDoc.exists) {
                planningData = normalizePlanningData(planningDoc.exists ? planningDoc.data() : {}, null);
                renderPlanningPanels(null);
                renderSummaryMessage('No spending data available. Complete the Bank setup to unlock your dashboard.');
                renderActionChecklist(null);
                showChartState('No spending data available yet. Complete your Bank setup first.');
                return;
            }

            const data = spendingDoc.data() || {};
            window.sankeyData = data;
            const model = buildFinancialModel(data);
            latestModel = model;
            planningData = normalizePlanningData(planningDoc.exists ? planningDoc.data() : {}, model);
            renderPlanningPanels(model);

            if (model.totalIncome <= 0) {
                renderSummaryMessage('No income data found. Complete the income questions in Bank setup.');
                renderActionChecklist(model);
                showChartState('No income data found. Complete the income part of the Bank setup.');
                return;
            }

            if (Object.keys(model.categoryTotals).length === 0) {
                renderSummaryMessage('No expense data found. Add monthly spending in the Bank setup.');
                renderActionChecklist(model);
                showChartState('No spending data found. Add expenses in Bank setup to render the Sankey flow.');
                return;
            }

            hideChartState();
            createOverviewDashboard(model);
            renderActionChecklist(model);
            bindSankeyResize();
        } catch (error) {
            console.error('Error loading data:', error);
            planningData = normalizePlanningData({}, latestModel);
            renderPlanningPanels(latestModel);
            renderSummaryMessage('Error loading your dashboard. Please refresh and try again.');
            renderActionChecklist(null);
            showChartState('We could not load your financial data. Please refresh and try again.');
        }
    }

    function createOverviewDashboard(model) {
        const { incomeSources, categoryTotals, totalIncome, totalExpenses, surplus } = model;

        const summaryCards = document.getElementById('summaryCards');
        summaryCards.innerHTML = `
            <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Income</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.round(totalIncome).toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, #ff5252 0%, #e53935 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Annual Expenses</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.round(totalExpenses).toLocaleString()}</div>
            </div>
            <div style="background: linear-gradient(135deg, ${surplus >= 0 ? '#2196f3' : '#ff7043'} 0%, ${surplus >= 0 ? '#1e88e5' : '#f4511e'} 100%); border-radius: 15px; padding: 25px; color: #fff;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">${surplus >= 0 ? 'Surplus' : 'Deficit'}</div>
                <div style="font-size: 32px; font-weight: bold;">$${Math.abs(Math.round(surplus)).toLocaleString()}</div>
                ${surplus < 0 ? '<div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">Spending currently exceeds income</div>' : ''}
            </div>
        `;

        createSankeyChart(model);
        createDonutChart('incomeChart', 'incomeLegend', incomeSources, totalIncome, 'Income', '#4caf50');
        const expenseData = Object.keys(categoryTotals).map(category => ({
            name: category,
            value: categoryTotals[category] * 12
        }));
        createDonutChart('expenseChart', 'expenseLegend', expenseData, totalExpenses, 'Expenses', '#ff5252');
    }

    function createSankeyChart(model) {
        const { incomeSources, categoryTotals, totalIncome, totalExpenses, surplus } = model;
        sankeyChartContainer.innerHTML = '';
        const width = Math.max(760, sankeyChartContainer.clientWidth || 0);
        const height = 420;

        const nodes = [{ name: 'Available Income', kind: 'pool' }];
        const links = [];

        incomeSources.forEach(source => {
            const sourceIndex = nodes.push({ name: source.name, kind: 'income' }) - 1;
            links.push({ source: sourceIndex, target: 0, value: source.value });
        });

        if (totalExpenses > totalIncome) {
            const deficitNode = nodes.push({ name: 'Debt / Credit', kind: 'debt' }) - 1;
            links.push({ source: deficitNode, target: 0, value: totalExpenses - totalIncome });
        }

        Object.entries(categoryTotals).forEach(([category, monthlyAmount]) => {
            const annualAmount = monthlyAmount * 12;
            if (annualAmount <= 0) return;
            const kind = category === 'Savings' ? 'savings' : 'expense';
            const categoryNode = nodes.push({ name: category, kind }) - 1;
            links.push({ source: 0, target: categoryNode, value: annualAmount });
        });

        if (surplus > 0) {
            const surplusNode = nodes.push({ name: 'Unallocated Surplus', kind: 'surplus' }) - 1;
            links.push({ source: 0, target: surplusNode, value: surplus });
        }

        const graph = d3.sankey()
            .nodeWidth(18)
            .nodePadding(18)
            .extent([[14, 20], [width - 14, height - 20]])({
                nodes: nodes.map(node => ({ ...node })),
                links: links.map(link => ({ ...link }))
            });

        const nodeColors = {
            income: '#4caf50',
            pool: '#81c784',
            expense: '#ef5350',
            savings: '#26a69a',
            surplus: '#42a5f5',
            debt: '#ffb300'
        };

        const tooltip = getChartTooltip();
        const svg = d3.select('#sankeyChart')
            .append('svg')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('width', '100%')
            .attr('height', height);

        svg.append('g')
            .attr('fill', 'none')
            .selectAll('path')
            .data(graph.links)
            .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', link => {
                const sourceKind = link.source.kind;
                const targetKind = link.target.kind;
                const color = sourceKind === 'income' ? nodeColors.income : nodeColors[targetKind] || '#777';
                return color;
            })
            .attr('stroke-opacity', 0.46)
            .attr('stroke-width', link => Math.max(1, link.width))
            .on('mousemove', (event, link) => {
                tooltip.style('opacity', 1)
                    .html(`<strong>${link.source.name} -> ${link.target.name}</strong><br>$${Math.round(link.value).toLocaleString()} / year`)
                    .style('left', `${event.pageX + 14}px`)
                    .style('top', `${event.pageY - 10}px`);
            })
            .on('mouseleave', () => {
                tooltip.style('opacity', 0);
            });

        const nodeGroup = svg.append('g')
            .selectAll('g')
            .data(graph.nodes)
            .join('g');

        nodeGroup.append('rect')
            .attr('x', node => node.x0)
            .attr('y', node => node.y0)
            .attr('height', node => Math.max(4, node.y1 - node.y0))
            .attr('width', node => node.x1 - node.x0)
            .attr('fill', node => nodeColors[node.kind] || '#7a7a7a')
            .attr('rx', 3)
            .attr('ry', 3)
            .on('mousemove', (event, node) => {
                const nodeValue = Math.max(
                    d3.sum(node.sourceLinks, link => link.value),
                    d3.sum(node.targetLinks, link => link.value)
                );
                tooltip.style('opacity', 1)
                    .html(`<strong>${node.name}</strong><br>$${Math.round(nodeValue).toLocaleString()} / year`)
                    .style('left', `${event.pageX + 14}px`)
                    .style('top', `${event.pageY - 10}px`);
            })
            .on('mouseleave', () => {
                tooltip.style('opacity', 0);
            });

        nodeGroup.append('text')
            .attr('x', node => node.x0 < width / 2 ? node.x1 + 8 : node.x0 - 8)
            .attr('y', node => (node.y0 + node.y1) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', node => node.x0 < width / 2 ? 'start' : 'end')
            .style('font-size', '12px')
            .style('fill', '#ddd')
            .text(node => node.name);
    }

    function renderActionChecklist(model) {
        const container = document.getElementById('actionChecklist');
        if (!model) {
            container.innerHTML = '';
            [
                { status: 'progress', title: 'Complete Bank Setup', detail: 'Add income and key spending categories to unlock insights.' },
                { status: 'next', title: 'Enable Money Flow View', detail: 'The Sankey chart appears automatically once data exists.' },
                { status: 'next', title: 'Create a Monthly Surplus', detail: 'Target positive cash flow by trimming high-impact categories.' }
            ].forEach(item => container.appendChild(buildChecklistItem(item)));
            return;
        }

        const housingRatio = model.totalIncome > 0 ? ((model.categoryTotals['Housing'] || 0) * 12) / model.totalIncome : 0;
        const foodLifestyle = ((model.categoryTotals['Food & Dining'] || 0) + (model.categoryTotals['Entertainment & Lifestyle'] || 0)) * 12;
        const lifestyleRatio = model.totalIncome > 0 ? foodLifestyle / model.totalIncome : 0;
        const emergencyFund = toAmount(window.sankeyData['Emergency Fund']);
        const retirement = toAmount(window.sankeyData['Retirement Savings']);
        const debtMonthly = toAmount(window.sankeyData['Credit Cards']) + toAmount(window.sankeyData['Personal Loans']) + toAmount(window.sankeyData['Student Loans']) + toAmount(window.sankeyData['Medical Debt']);

        const actions = [
            {
                status: model.answeredCount >= 20 ? 'done' : 'progress',
                title: 'Complete profile quality',
                detail: `${model.answeredCount} answers captured. Reach 20+ fields for stronger recommendations.`
            },
            {
                status: model.totalIncome > 0 ? 'done' : 'progress',
                title: 'Income visibility',
                detail: model.totalIncome > 0 ? 'Income data is complete and flowing into your dashboard.' : 'Add monthly income to unlock accurate budgeting.'
            },
            {
                status: housingRatio <= 0.35 ? 'done' : 'progress',
                title: 'Housing affordability',
                detail: `Housing is ${(housingRatio * 100).toFixed(1)}% of income. Keep it near 35% or below.`
            },
            {
                status: emergencyFund > 0 ? 'done' : 'progress',
                title: 'Emergency buffer',
                detail: emergencyFund > 0 ? `You save $${Math.round(emergencyFund).toLocaleString()} monthly toward emergency cash.` : 'Start with a small emergency fund contribution this month.'
            },
            {
                status: retirement > 0 ? 'done' : 'progress',
                title: 'Retirement contribution',
                detail: retirement > 0 ? `You contribute $${Math.round(retirement).toLocaleString()} monthly to retirement.` : 'Add a monthly retirement contribution.'
            },
            {
                status: debtMonthly > 0 && model.surplus > 0 ? 'progress' : 'next',
                title: 'Debt payoff plan',
                detail: debtMonthly > 0 ? `Debt payments are $${Math.round(debtMonthly).toLocaleString()} per month. Use surplus to accelerate payoff.` : 'No major debt payments detected.'
            },
            {
                status: lifestyleRatio <= 0.25 ? 'done' : 'progress',
                title: 'Lifestyle spend control',
                detail: `Food + lifestyle spending is ${(lifestyleRatio * 100).toFixed(1)}% of income.`
            },
            {
                status: model.surplus > 0 ? 'done' : 'progress',
                title: 'Monthly surplus target',
                detail: model.surplus > 0 ? `You are currently positive by $${Math.round(model.surplus).toLocaleString()} per year.` : 'Reduce expenses or increase income to move into surplus.'
            }
        ];

        container.innerHTML = '';
        actions.forEach(item => container.appendChild(buildChecklistItem(item)));
    }

    function renderProductRoadmap() {
        const roadmap = [
            { status: 'done', title: 'Sankey Money Flow', detail: 'Annual income and expenses now render in a stable Sankey view.' },
            { status: 'done', title: 'Action Checklist', detail: 'Dashboard now turns financial data into concrete next steps.' },
            { status: 'done', title: 'Questionnaire Refactor', detail: 'Bank setup now supports quick mode and a cleaner question flow.' },
            { status: 'done', title: 'Category Budgets', detail: 'Set target caps by category with automatic over/under tracking.' },
            { status: 'done', title: 'Goal Buckets', detail: 'Track sinking funds and long-term goals with progress bars.' },
            { status: 'done', title: 'Bill Calendar', detail: 'Track recurring due dates and fixed monthly obligations.' },
            { status: 'done', title: 'Alert Engine', detail: 'Detect spending risk, deficits, and budget overruns automatically.' },
            { status: 'done', title: 'Shared Budgets', detail: 'Manage simple household collaborators and roles.' },
            { status: 'done', title: 'Exports & Reports', detail: 'Download CSV/JSON snapshots and print a budget report.' }
        ];

        const container = document.getElementById('productRoadmap');
        container.innerHTML = '';
        roadmap.forEach(item => container.appendChild(buildChecklistItem(item)));
    }

    function buildChecklistItem(item) {
        const li = document.createElement('li');
        li.className = 'checklist-item';
        const statusMap = {
            done: { label: 'Live', className: 'status-done' },
            progress: { label: 'In Progress', className: 'status-progress' },
            next: { label: 'Next', className: 'status-next' }
        };
        const status = statusMap[item.status] || statusMap.next;
        li.innerHTML = `
            <span class="status-pill ${status.className}">${status.label}</span>
            <div>
                <strong>${item.title}</strong>
                <span>${item.detail}</span>
            </div>
        `;
        return li;
    }
    
    function createDonutChart(containerId, legendId, data, total, title, colorScheme) {
        const container = document.getElementById(containerId);
        const legendContainer = document.getElementById(legendId);
        
        // Clear previous content
        container.innerHTML = '';
        legendContainer.innerHTML = '';
        
        if (data.length === 0 || total === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No data available</div>';
            return;
        }
        
        const width = container.clientWidth || 300;
        const height = 350;
        const radius = Math.min(width, height) / 2 - 20;
        
        const svg = d3.select(`#${containerId}`)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
        
        // Color scale
        const colors = d3.scaleOrdinal()
            .domain(data.map(d => d.name))
            .range(d3.schemeCategory10);
        
        // Create pie generator
        const pie = d3.pie()
            .value(d => d.value)
            .sort(null)
            .padAngle(0.02);
        
        // Create arc generator
        const arc = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius);
        
        const arcHover = d3.arc()
            .innerRadius(radius * 0.6)
            .outerRadius(radius + 10);
        
        // Reuse a single shared tooltip
        const tooltip = getChartTooltip();
        
        // Draw arcs
        const arcs = svg.selectAll("path")
            .data(pie(data))
            .enter()
            .append("path")
            .attr("fill", d => colors(d.data.name))
            .attr("d", arc)
            .style("cursor", "pointer")
            .style("stroke", "#222")
            .style("stroke-width", "2px")
            .style("opacity", 0)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arcHover)
                    .style("opacity", 1)
                    .style("stroke", "#fff")
                    .style("stroke-width", "3px");
                
                const percentage = ((d.data.value / total) * 100).toFixed(1);
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 1);
                tooltip.html(`
                    <strong>${d.data.name}</strong><br/>
                    <span style="color: #4caf50;">$${d.data.value.toLocaleString()}</span><br/>
                    <span style="color: #999; font-size: 12px;">${percentage}% of total ${title.toLowerCase()}</span>
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("d", arc)
                    .style("opacity", 0.9)
                    .style("stroke", "#222")
                    .style("stroke-width", "2px");
                
                tooltip.transition()
                    .duration(200)
                    .style("opacity", 0);
            });
        
        // Animate arcs
        arcs.transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .style("opacity", 0.9)
            .attrTween("d", function(d) {
                const interpolate = d3.interpolate({startAngle: 0, endAngle: 0}, d);
                return function(t) {
                    return arc(interpolate(t));
                };
            });
        
        // Center label
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "-8")
            .style("font-size", "16px")
            .style("font-weight", "600")
            .style("fill", colorScheme)
            .text(`Total ${title}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(600)
            .style("opacity", 1);
        
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "12")
            .style("font-size", "22px")
            .style("font-weight", "bold")
            .style("fill", "#fff")
            .text(`$${total.toLocaleString()}`)
            .style("opacity", 0)
            .transition()
            .duration(800)
            .delay(700)
            .style("opacity", 1);
        
        // Create legend
        data.forEach((item, i) => {
            const percentage = ((item.value / total) * 100).toFixed(1);
            const legendItem = document.createElement('div');
            legendItem.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 5px; background: #333;';
            legendItem.innerHTML = `
                <div style="width: 16px; height: 16px; background: ${colors(item.name)}; border-radius: 3px; flex-shrink: 0;"></div>
                <div style="flex: 1; color: #ccc; font-size: 13px;">${item.name}</div>
                <div style="color: #fff; font-weight: bold; font-size: 13px;">$${item.value.toLocaleString()}</div>
                <div style="color: #999; font-size: 12px; min-width: 45px; text-align: right;">${percentage}%</div>
            `;
            legendContainer.appendChild(legendItem);
        });
    }
</script>
</body>
</html> 
